<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
    <RootNamespace>Mystira.Shared</RootNamespace>

    <!-- Package metadata -->
    <PackageId>Mystira.Shared</PackageId>
    <Version>0.2.0-alpha</Version>
    <Authors>Mystira Team</Authors>
    <Company>PhoenixVC</Company>
    <Description>Shared infrastructure for Mystira platform services - authentication, authorization, middleware, and cross-cutting concerns</Description>
    <PackageTags>mystira;shared;authentication;authorization;middleware</PackageTags>
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    <PackageProjectUrl>https://github.com/phoenixvc/Mystira.workspace</PackageProjectUrl>
    <PackageReadmeFile>README.md</PackageReadmeFile>
    <RepositoryUrl>https://github.com/phoenixvc/Mystira.workspace.git</RepositoryUrl>
    <RepositoryType>git</RepositoryType>

    <!-- Build configuration -->
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <GeneratePackageOnBuild>false</GeneratePackageOnBuild>
    <IsPackable>true</IsPackable>
  </PropertyGroup>

  <!-- Source Link for debugging -->
  <PropertyGroup>
    <PublishRepositoryUrl>true</PublishRepositoryUrl>
    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="9.0.11" />
    <PackageReference Include="Microsoft.Identity.Web" Version="4.2.0" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.11" />
    <PackageReference Include="Microsoft.Extensions.Options" Version="9.0.11" />
    <PackageReference Include="Microsoft.SourceLink.GitHub" Version="8.0.0" PrivateAssets="All" />
    <PackageReference Include="OpenTelemetry.Api" Version="1.14.0" />
    <PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="8.15.0" />
    <!-- Middleware and Telemetry dependencies -->
    <PackageReference Include="Microsoft.ApplicationInsights.AspNetCore" Version="2.23.0" />
    <PackageReference Include="Microsoft.AspNetCore.Http.Abstractions" Version="2.3.0" />
    <PackageReference Include="Serilog" Version="4.3.0" />
    <!-- Azure Key Vault configuration -->
    <PackageReference Include="Azure.Extensions.AspNetCore.Configuration.Secrets" Version="1.4.0" />
    <PackageReference Include="Azure.Identity" Version="1.17.1" />
    <!-- Wave 1: Resilience (Polly v8 Pipelines) -->
    <PackageReference Include="Microsoft.Extensions.Http.Polly" Version="9.0.11" />
    <PackageReference Include="Microsoft.Extensions.Http.Resilience" Version="9.10.0" />
    <PackageReference Include="Polly" Version="8.6.5" />
    <PackageReference Include="Polly.Extensions" Version="8.6.5" />
    <!-- Wave 2: Caching -->
    <PackageReference Include="Microsoft.Extensions.Caching.StackExchangeRedis" Version="9.0.11" />
    <!-- Wave 3: Wolverine (replaces MediatR) -->
    <PackageReference Include="WolverineFx" Version="5.9.2" />
    <PackageReference Include="WolverineFx.AzureServiceBus" Version="5.9.2" />
    <!-- Wave 2 Data: Entity Framework Core -->
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="9.0.11" />
    <!-- Polyglot Persistence: Ardalis.Specification -->
    <PackageReference Include="Ardalis.Specification" Version="9.3.1" />
    <PackageReference Include="Ardalis.Specification.EntityFrameworkCore" Version="9.3.1" />
    <!-- Polyglot Persistence: Wolverine EF Core for saga/outbox -->
    <PackageReference Include="WolverineFx.EntityFrameworkCore" Version="5.9.2" />
    <!-- CodeAnalysis version alignment: EF Core Design requires 4.8.0, JasperFx.RuntimeCompiler requires 4.14.0+ -->
    <PackageReference Include="Microsoft.CodeAnalysis.Common" Version="4.14.0" />
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp.Workspaces" Version="4.14.0" />
    <PackageReference Include="Microsoft.CodeAnalysis.Workspaces.Common" Version="4.14.0" />
    <PackageReference Include="Microsoft.CodeAnalysis.Workspaces.MSBuild" Version="4.14.0" />
  </ItemGroup>

  <ItemGroup>
    <None Include="README.md" Pack="true" PackagePath="\" />
  </ItemGroup>

  <!--
    ==========================================================================
    REPOSITORY PATTERN: Recommended Approach
    ==========================================================================

    Use Generic Repository + Ardalis.Specification (zero boilerplate):

      services.AddScoped(typeof(IRepository<>), typeof(RepositoryBase<>));

      // Use specifications for queries:
      var products = await _repo.ListAsync(new LowStockProductsSpec(10));

    See: docs/guides/entity-and-repository-guide.md

    ==========================================================================
    SOURCE GENERATORS: Experimental (Commented Out)
    ==========================================================================

    Source generators are available but NOT recommended for most cases.
    Generic Repo + Specs covers 90% of use cases with less complexity.

    Enable only if you have 20+ similar repositories with custom methods
    that cannot be expressed as specifications.

    <ItemGroup>
      <ProjectReference Include="..\Mystira.Shared.Generators\Mystira.Shared.Generators.csproj"
                        OutputItemType="Analyzer"
                        ReferenceOutputAssembly="false" />
    </ItemGroup>

    ==========================================================================
    FUTURE: Potential AOP Alternatives
    ==========================================================================

    Consider these modern alternatives for cross-cutting concerns:

    1. .NET 8+ Interceptors (compile-time method interception):
       - No runtime reflection, type-safe
       - Good for caching, logging, validation
       - See: https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-12#interceptors

    2. Scrutor (convention-based DI registration):
       - Auto-discover and register services by convention
       - Decorator pattern for cross-cutting concerns
       - See: https://github.com/khellang/Scrutor

    3. Castle.DynamicProxy (runtime AOP):
       - Full AOP with interception
       - Good for complex scenarios
       - See: https://github.com/castleproject/Core

    4. Metalama (successor to PostSharp):
       - Compile-time AOP, fully type-safe
       - License required for commercial use
       - See: https://www.postsharp.net/metalama

    ==========================================================================
  -->

</Project>
