# Kubernetes ServiceAccounts with Azure Workload Identity
# These ServiceAccounts enable pods to authenticate to Azure services using managed identities
#
# Usage:
# 1. Apply these manifests to your AKS cluster
# 2. The client-id annotation should be set to the managed identity client ID
# 3. Pods using these ServiceAccounts will automatically get Azure AD tokens
#
# To get the client ID after Terraform apply:
#   terraform output -json | jq -r '.admin_api_identity_client_id.value'
#
# Note: Admin UI is a browser-based SPA and does not need a ServiceAccount
#       (it uses MSAL authentication in the browser)

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-api-sa
  namespace: mystira
  labels:
    app.kubernetes.io/name: admin-api
    app.kubernetes.io/component: api
    azure.workload.identity/use: "true"
  annotations:
    # Set this to the managed identity client ID from Terraform output
    azure.workload.identity/client-id: "${ADMIN_API_CLIENT_ID}"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: story-generator-sa
  namespace: mystira
  labels:
    app.kubernetes.io/name: story-generator
    app.kubernetes.io/component: backend
    azure.workload.identity/use: "true"
  annotations:
    # Set this to the managed identity client ID from Terraform output
    azure.workload.identity/client-id: "${STORY_GENERATOR_CLIENT_ID}"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: publisher-sa
  namespace: mystira
  labels:
    app.kubernetes.io/name: publisher
    app.kubernetes.io/component: backend
    azure.workload.identity/use: "true"
  annotations:
    # Set this to the managed identity client ID from Terraform output
    azure.workload.identity/client-id: "${PUBLISHER_CLIENT_ID}"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: chain-sa
  namespace: mystira
  labels:
    app.kubernetes.io/name: chain
    app.kubernetes.io/component: blockchain
    azure.workload.identity/use: "true"
  annotations:
    # Set this to the managed identity client ID from Terraform output
    azure.workload.identity/client-id: "${CHAIN_CLIENT_ID}"
