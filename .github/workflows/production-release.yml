name: "[Deploy] Production"

# Production Environment Deployment: Deploys infrastructure and services to production
# Security: Requires manual confirmation "DEPLOY TO PRODUCTION"
# Steps: Validate input, deploy Terraform infrastructure, deploy Kubernetes services
# Environment: https://mystira.app
# Trigger: Manual workflow_dispatch only

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string

jobs:
  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'DEPLOY TO PRODUCTION'
        run: |
          echo "Invalid confirmation. You must type 'DEPLOY TO PRODUCTION' exactly."
          exit 1

  deploy-infrastructure:
    name: Deploy Infrastructure to Production
    runs-on: ubuntu-latest
    needs: [validate-confirmation]
    environment:
      name: production
      url: https://mystira.app
    permissions:
      contents: read
      id-token: write
    env:
      ENVIRONMENT: prod
      TF_VERSION: 1.5.0
      # Resource Groups (ADR-0017)
      AZURE_RESOURCE_GROUP: mys-prod-core-rg-san
      CHAIN_RG: mys-prod-chain-rg-san
      PUBLISHER_RG: mys-prod-publisher-rg-san
      STORY_RG: mys-prod-story-rg-san
      ADMIN_RG: mys-prod-admin-rg-san
      APP_RG: mys-prod-app-rg-san
      SHARED_ACR_RG: mys-shared-acr-rg-san
      # Infrastructure
      AKS_CLUSTER_NAME: mys-prod-core-aks-san
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          ref: main

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Set Azure credentials for Terraform
        run: |
          ARM_CLIENT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientId')
          ARM_CLIENT_SECRET=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
          ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
          ARM_TENANT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.tenantId')

          echo "::add-mask::$ARM_CLIENT_SECRET"

          {
            echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
            echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET"
            echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
            echo "ARM_TENANT_ID=$ARM_TENANT_ID"
            echo "ARM_USE_CLI=false"
          } >> "$GITHUB_ENV"

      - name: Terraform Init
        run: |
          cd infra/terraform/environments/prod
          terraform init

      - name: Terraform Plan
        run: |
          cd infra/terraform/environments/prod
          terraform plan -out=tfplan

      - name: Terraform Apply
        run: |
          cd infra/terraform/environments/prod
          terraform apply -auto-approve tfplan

  deploy-services:
    name: Deploy Services to Production
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    environment:
      name: production
    permissions:
      contents: read
      id-token: write
    env:
      # Resource Groups (ADR-0017)
      AZURE_RESOURCE_GROUP: mys-prod-core-rg-san
      CHAIN_RG: mys-prod-chain-rg-san
      PUBLISHER_RG: mys-prod-publisher-rg-san
      STORY_RG: mys-prod-story-rg-san
      ADMIN_RG: mys-prod-admin-rg-san
      APP_RG: mys-prod-app-rg-san
      AKS_CLUSTER_NAME: mys-prod-core-aks-san
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          ref: main

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace if not exists
        run: |
          kubectl create namespace mys-prod --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy all services to production
        run: |
          kubectl apply -k infra/kubernetes/overlays/prod

          # Wait for deployments with longer timeout for production
          kubectl rollout status deployment/mys-publisher -n mys-prod --timeout=600s || true
          kubectl rollout status deployment/mys-story-generator -n mys-prod --timeout=600s || true
          kubectl rollout status statefulset/mys-chain -n mys-prod --timeout=900s || true

      - name: Verify deployments
        run: |
          echo "## Production Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "### Publisher" >> $GITHUB_STEP_SUMMARY
          kubectl get deployment mys-publisher -n mys-prod >> $GITHUB_STEP_SUMMARY || true
          echo "### Story Generator" >> $GITHUB_STEP_SUMMARY
          kubectl get deployment mys-story-generator -n mys-prod >> $GITHUB_STEP_SUMMARY || true
          echo "### Chain" >> $GITHUB_STEP_SUMMARY
          kubectl get statefulset mys-chain -n mys-prod >> $GITHUB_STEP_SUMMARY || true

      - name: Verify Static Web Apps
        run: |
          echo "### Static Web Apps" >> $GITHUB_STEP_SUMMARY

          # Check Mystira.App SWA
          APP_SWA=$(az staticwebapp list --resource-group ${{ env.APP_RG }} --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$APP_SWA" ]; then
            APP_STATUS=$(az staticwebapp show --name "$APP_SWA" --query "contentDistributionEndpoint" -o tsv 2>/dev/null || echo "Not available")
            echo "- Mystira.App SWA: $APP_SWA → $APP_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Mystira.App SWA: Not deployed" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Story Generator SWA
          STORY_SWA=$(az staticwebapp list --resource-group ${{ env.STORY_RG }} --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$STORY_SWA" ]; then
            STORY_STATUS=$(az staticwebapp show --name "$STORY_SWA" --query "contentDistributionEndpoint" -o tsv 2>/dev/null || echo "Not available")
            echo "- Story Generator SWA: $STORY_SWA → $STORY_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Story Generator SWA: Not deployed" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-services]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: production" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure Deploy: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Services Deploy: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://mystira.app" >> $GITHUB_STEP_SUMMARY
          echo "- Publisher: https://publisher.mystira.app" >> $GITHUB_STEP_SUMMARY
          echo "- Chain: https://chain.mystira.app" >> $GITHUB_STEP_SUMMARY
          echo "- Story Generator API: https://story-api.mystira.app" >> $GITHUB_STEP_SUMMARY
          echo "- Story Generator SWA: https://story.mystira.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Production deployment completed. Monitor services closely." >> $GITHUB_STEP_SUMMARY
