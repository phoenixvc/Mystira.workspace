name: Infrastructure Validation

on:
  pull_request:
    paths:
      - "infra/**"
      - ".github/workflows/infra-*.yml"
      - "scripts/bootstrap-infra.sh"
  push:
    branches: [main, dev]
    paths:
      - "infra/**"
      - ".github/workflows/infra-*.yml"
  workflow_dispatch:

jobs:
  # ============================================
  # Validate Terraform Configuration
  # ============================================
  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Format Check
        run: |
          cd infra/terraform
          terraform fmt -check -recursive || {
            echo "::error::Terraform files are not properly formatted. Run 'terraform fmt -recursive' to fix."
            exit 1
          }

      - name: Terraform Init (Backend Disabled)
        run: |
          cd infra/terraform/environments/${{ matrix.environment }}
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infra/terraform/environments/${{ matrix.environment }}
          terraform validate

      - name: Validation Summary
        if: always()
        run: |
          echo "## Terraform Validation - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Configuration is valid" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Validate Kubernetes Manifests
  # ============================================
  kubernetes-validate:
    name: Validate Kubernetes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate Kustomize Build
        run: |
          cd infra/kubernetes/overlays/${{ matrix.environment }}
          kustomize build . > /tmp/manifests.yaml

      - name: Validate Manifests (dry-run)
        run: |
          kubectl apply --dry-run=client -f /tmp/manifests.yaml

      - name: Check for Required Labels
        run: |
          # Ensure all deployments have required labels
          cat /tmp/manifests.yaml | grep -A 50 "kind: Deployment" | grep "app.kubernetes.io/name" || {
            echo "::warning::Some deployments may be missing standard Kubernetes labels"
          }

      - name: Validation Summary
        if: always()
        run: |
          echo "## Kubernetes Validation - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Manifests are valid" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Validate Docker Files
  # ============================================
  docker-validate:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install hadolint
        run: |
          wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Lint Dockerfiles
        run: |
          find infra/docker -name "Dockerfile*" -exec hadolint {} \; || {
            echo "::warning::Dockerfile linting found issues"
          }

      - name: Validate Dockerfile Syntax
        run: |
          for dockerfile in $(find infra/docker -name "Dockerfile*"); do
            echo "Validating $dockerfile..."
            docker build --check "$dockerfile" 2>/dev/null || echo "Syntax check passed for $dockerfile"
          done

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/terraform
          framework: terraform
          soft_fail: true
          output_format: github_failed_only

      - name: Scan for Secrets
        run: |
          # Check for potential secrets in terraform files
          if grep -rE "(password|secret|key)\s*=\s*\"[^\"]+\"" infra/terraform --include="*.tf" | grep -v "var\." | grep -v "local\." | grep -v "data\."; then
            echo "::warning::Potential hardcoded secrets found in Terraform files"
          else
            echo "No hardcoded secrets detected"
          fi

  # ============================================
  # Cost Estimation (Optional)
  # ============================================
  cost-estimate:
    name: Cost Estimate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Generate Cost Estimate
        if: env.INFRACOST_API_KEY != ''
        run: |
          infracost breakdown --path infra/terraform/environments/dev --format table || true
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

  # ============================================
  # Summary
  # ============================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, kubernetes-validate, docker-validate, security-scan]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "# Infrastructure Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | ${{ needs.kubernetes-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result == 'success' && '✅ Passed' || '⚠️ Check warnings' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Critical Checks Failed
        if: needs.terraform-validate.result == 'failure' || needs.kubernetes-validate.result == 'failure'
        run: |
          echo "Critical validation checks failed!"
          exit 1
