# Key Vault Secrets Management Workflow
# Manages Azure Key Vault secrets for application configuration
#
# This workflow allows setting secrets via GitHub Actions without exposing them in code.
# Secrets are stored in GitHub Secrets and synced to Azure Key Vault.
#
# Per ADR-0017, each service has its own Key Vault in its service-specific RG.

name: Key Vault Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      service:
        description: 'Service Key Vault to manage (per ADR-0017)'
        required: true
        type: choice
        options:
          - admin-api
          - chain
          - publisher
          - story-generator
          - all
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync-all
          - sync-entra-id
          - list-secrets

permissions:
  id-token: write
  contents: read

env:
  # Key Vault naming pattern per ADR-0017: mys-{env}-{service}-kv-{region}
  # Service Key Vaults (in service-specific RGs)
  # - Admin API: mys-{env}-admin-kv-san
  # - Chain: mys-{env}-chain-kv-san
  # - Publisher: mys-{env}-pub-kv-san
  # - Story Generator: mys-{env}-story-kv-san
  REGION_CODE: san

jobs:
  sync-secrets:
    name: Sync Secrets to Key Vault
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Key Vault names
        id: kv
        run: |
          ENV="${{ github.event.inputs.environment }}"
          SERVICE="${{ github.event.inputs.service }}"
          REGION="${{ env.REGION_CODE }}"

          # Build Key Vault name based on service (per ADR-0017)
          # Key Vault names have 24 char limit, so we use abbreviations
          get_kv_name() {
            local svc=$1
            case "$svc" in
              admin-api)
                echo "mys-${ENV}-admin-kv-${REGION}"
                ;;
              chain)
                echo "mys-${ENV}-chain-kv-${REGION}"
                ;;
              publisher)
                echo "mys-${ENV}-pub-kv-${REGION}"
                ;;
              story-generator)
                echo "mys-${ENV}-story-kv-${REGION}"
                ;;
            esac
          }

          if [ "$SERVICE" = "all" ]; then
            # Set all Key Vault names for bulk operations
            echo "admin_kv=$(get_kv_name admin-api)" >> $GITHUB_OUTPUT
            echo "chain_kv=$(get_kv_name chain)" >> $GITHUB_OUTPUT
            echo "publisher_kv=$(get_kv_name publisher)" >> $GITHUB_OUTPUT
            echo "story_kv=$(get_kv_name story-generator)" >> $GITHUB_OUTPUT
            echo "is_all=true" >> $GITHUB_OUTPUT
          else
            # Set single Key Vault name
            KV_NAME=$(get_kv_name "$SERVICE")
            echo "name=$KV_NAME" >> $GITHUB_OUTPUT
            echo "is_all=false" >> $GITHUB_OUTPUT
          fi

          echo "## Key Vault Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${SERVICE}" >> $GITHUB_STEP_SUMMARY

      - name: List existing secrets
        if: github.event.inputs.action == 'list-secrets'
        run: |
          list_secrets() {
            local kv_name=$1
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Secrets in $kv_name" >> $GITHUB_STEP_SUMMARY
            if az keyvault show --name "$kv_name" &> /dev/null; then
              az keyvault secret list --vault-name "$kv_name" --query "[].name" -o tsv | while read secret; do
                echo "- $secret" >> $GITHUB_STEP_SUMMARY
              done
            else
              echo "- ⚠️ Key Vault not found" >> $GITHUB_STEP_SUMMARY
            fi
          }

          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            echo "## All Service Key Vaults" >> $GITHUB_STEP_SUMMARY
            list_secrets "${{ steps.kv.outputs.admin_kv }}"
            list_secrets "${{ steps.kv.outputs.chain_kv }}"
            list_secrets "${{ steps.kv.outputs.publisher_kv }}"
            list_secrets "${{ steps.kv.outputs.story_kv }}"
          else
            echo "## Existing secrets in ${{ steps.kv.outputs.name }}" >> $GITHUB_STEP_SUMMARY
            list_secrets "${{ steps.kv.outputs.name }}"
          fi

      - name: Sync Entra ID secrets
        if: (github.event.inputs.action == 'sync-entra-id' || github.event.inputs.action == 'sync-all') && steps.kv.outputs.is_all != 'true'
        run: |
          echo "Syncing Entra ID configuration to Key Vault..."
          KV_NAME="${{ steps.kv.outputs.name }}"

          # Set Entra ID tenant and client IDs
          if [ -n "${{ secrets.ENTRA_TENANT_ID }}" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "AzureAd--TenantId" \
              --value "${{ secrets.ENTRA_TENANT_ID }}" \
              --description "Azure AD Tenant ID for authentication"
            echo "✅ Set AzureAd--TenantId in $KV_NAME" >> $GITHUB_STEP_SUMMARY
          fi

          # Only set Admin API client ID for admin-api service
          if [ "${{ github.event.inputs.service }}" = "admin-api" ] && [ -n "${{ secrets.ENTRA_ADMIN_API_CLIENT_ID }}" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "AzureAd--ClientId" \
              --value "${{ secrets.ENTRA_ADMIN_API_CLIENT_ID }}" \
              --description "Admin API Client ID"
            echo "✅ Set AzureAd--ClientId in $KV_NAME" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.service }}" = "admin-api" ] && [ -n "${{ secrets.ENTRA_ADMIN_UI_CLIENT_ID }}" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "AdminUI--ClientId" \
              --value "${{ secrets.ENTRA_ADMIN_UI_CLIENT_ID }}" \
              --description "Admin UI Client ID"
            echo "✅ Set AdminUI--ClientId in $KV_NAME" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Sync all application secrets
        if: github.event.inputs.action == 'sync-all' && steps.kv.outputs.is_all != 'true'
        run: |
          echo "Syncing additional application secrets..."
          KV_NAME="${{ steps.kv.outputs.name }}"

          # Database credentials (if stored in GitHub secrets)
          if [ -n "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "PostgreSQL--AdminPassword" \
              --value "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
              --description "PostgreSQL admin password"
            echo "✅ Set PostgreSQL--AdminPassword in $KV_NAME" >> $GITHUB_STEP_SUMMARY
          fi

          # Redis connection (if stored in GitHub secrets)
          if [ -n "${{ secrets.REDIS_CONNECTION_STRING }}" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "Redis--ConnectionString" \
              --value "${{ secrets.REDIS_CONNECTION_STRING }}" \
              --description "Redis connection string"
            echo "✅ Set Redis--ConnectionString in $KV_NAME" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Secrets Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            echo "- **Key Vaults**: All service Key Vaults" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Key Vault**: ${{ steps.kv.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Action**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
