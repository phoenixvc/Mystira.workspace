# Key Vault Secrets Management Workflow
# Lists and verifies secrets in Azure Key Vault
#
# Per ADR-0017, each service has its own Key Vault in its service-specific RG.
#
# SECRET CATEGORIES:
# ALL secrets are auto-populated by Terraform (no manual sync needed):
#    - postgres-connection-string, redis-connection-string, servicebus-connection-string
#    - appinsights-connection-string
#    - azure-ad-tenant-id, azure-ad-client-id, admin-ui-client-id (from entra_id module)
#    - azure-ai-endpoint, azure-ai-api-key (from shared_azure_ai module)
#
# This workflow is primarily for listing and verifying secrets.
#
# NOTE: All service secrets are fully auto-populated by Terraform modules.

name: "Infra: KeyVault Secrets"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      service:
        description: 'Service Key Vault to manage (per ADR-0017)'
        required: true
        type: choice
        options:
          - story-generator
          - admin-api
          - publisher
          - chain
          - all
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - list-secrets
          - verify-secrets

permissions:
  id-token: write
  contents: read

env:
  REGION_CODE: san

jobs:
  manage-secrets:
    name: Manage Key Vault Secrets
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Key Vault names
        id: kv
        run: |
          ENV="${{ github.event.inputs.environment }}"
          SERVICE="${{ github.event.inputs.service }}"
          REGION="${{ env.REGION_CODE }}"

          # Build Key Vault name based on service
          # Key Vault names have 24 char limit
          get_kv_name() {
            local svc=$1
            case "$svc" in
              admin-api)      echo "mys-${ENV}-adm-kv-${REGION}" ;;
              chain)          echo "mys-${ENV}-chain-kv-${REGION}" ;;
              publisher)      echo "mys-${ENV}-pub-kv-${REGION}" ;;
              story-generator) echo "mys-${ENV}-story-kv-${REGION}" ;;
            esac
          }

          if [ "$SERVICE" = "all" ]; then
            echo "admin_kv=$(get_kv_name admin-api)" >> $GITHUB_OUTPUT
            echo "chain_kv=$(get_kv_name chain)" >> $GITHUB_OUTPUT
            echo "publisher_kv=$(get_kv_name publisher)" >> $GITHUB_OUTPUT
            echo "story_kv=$(get_kv_name story-generator)" >> $GITHUB_OUTPUT
            echo "is_all=true" >> $GITHUB_OUTPUT
          else
            echo "name=$(get_kv_name "$SERVICE")" >> $GITHUB_OUTPUT
            echo "is_all=false" >> $GITHUB_OUTPUT
          fi

          echo "env_upper=$(echo $ENV | tr '[:lower:]' '[:upper:]')" >> $GITHUB_OUTPUT

      - name: List existing secrets
        if: github.event.inputs.action == 'list-secrets'
        run: |
          list_secrets() {
            local kv_name=$1
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Secrets in $kv_name" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret Name | Source |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
            if az keyvault show --name "$kv_name" &> /dev/null; then
              az keyvault secret list --vault-name "$kv_name" --query "[].{name:name, tags:tags}" -o json | \
                jq -r '.[] | "| \(.name) | \(if .tags.Source then .tags.Source else "Unknown" end) |"' >> $GITHUB_STEP_SUMMARY
            else
              echo "| ⚠️ Key Vault not found | - |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "# Key Vault Secrets Audit" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All secrets are auto-populated by Terraform. No manual secrets required." >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            list_secrets "${{ steps.kv.outputs.story_kv }}"
            list_secrets "${{ steps.kv.outputs.admin_kv }}"
            list_secrets "${{ steps.kv.outputs.publisher_kv }}"
            list_secrets "${{ steps.kv.outputs.chain_kv }}"
          else
            list_secrets "${{ steps.kv.outputs.name }}"
          fi

      - name: Verify secrets
        if: github.event.inputs.action == 'verify-secrets'
        run: |
          verify_secret() {
            local kv_name=$1
            local secret_name=$2
            local required=$3
            if az keyvault secret show --vault-name "$kv_name" --name "$secret_name" &> /dev/null; then
              echo "| $secret_name | ✅ Present |" >> $GITHUB_STEP_SUMMARY
            elif [ "$required" = "true" ]; then
              echo "| $secret_name | ❌ Missing (Required) |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $secret_name | ⚠️ Missing (Optional) |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          verify_kv() {
            local kv_name=$1
            local service=$2
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### $service ($kv_name)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

            case "$service" in
              story-generator)
                verify_secret "$kv_name" "postgres-connection-string" "true"
                verify_secret "$kv_name" "redis-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                verify_secret "$kv_name" "azure-ai-endpoint" "true"
                verify_secret "$kv_name" "azure-ai-api-key" "true"
                ;;
              admin-api)
                verify_secret "$kv_name" "postgres-connection-string" "true"
                verify_secret "$kv_name" "redis-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                verify_secret "$kv_name" "azure-ad-tenant-id" "true"
                verify_secret "$kv_name" "azure-ad-client-id" "true"
                verify_secret "$kv_name" "admin-ui-client-id" "true"
                ;;
              publisher)
                verify_secret "$kv_name" "servicebus-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                ;;
              chain)
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                ;;
            esac
          }

          echo "# Secrets Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All secrets should be auto-populated by Terraform." >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            verify_kv "${{ steps.kv.outputs.story_kv }}" "story-generator"
            verify_kv "${{ steps.kv.outputs.admin_kv }}" "admin-api"
            verify_kv "${{ steps.kv.outputs.publisher_kv }}" "publisher"
            verify_kv "${{ steps.kv.outputs.chain_kv }}" "chain"
          else
            verify_kv "${{ steps.kv.outputs.name }}" "${{ github.event.inputs.service }}"
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Secrets Management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All secrets are auto-populated by Terraform:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Secrets Source |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Story-Generator | shared PostgreSQL, Redis, Monitoring, Azure AI |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin-API | shared PostgreSQL, Redis, Monitoring, Entra ID |" >> $GITHUB_STEP_SUMMARY
          echo "| Publisher | shared Service Bus, Monitoring |" >> $GITHUB_STEP_SUMMARY
          echo "| Chain | shared Monitoring |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If secrets are missing, run \`terraform apply\` to populate them." >> $GITHUB_STEP_SUMMARY
