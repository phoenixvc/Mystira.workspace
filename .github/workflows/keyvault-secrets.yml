# Key Vault Secrets Management Workflow
# Manages Azure Key Vault secrets for application configuration
#
# This workflow allows setting secrets via GitHub Actions without exposing them in code.
# Secrets are stored in GitHub Secrets and synced to Azure Key Vault.

name: Key Vault Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync-all
          - sync-entra-id
          - list-secrets

permissions:
  id-token: write
  contents: read

env:
  # Key Vault names per environment
  DEV_KEY_VAULT: mys-dev-admin-kv-san
  STAGING_KEY_VAULT: mys-staging-admin-kv-eus
  PROD_KEY_VAULT: mys-prod-admin-kv-san

jobs:
  sync-secrets:
    name: Sync Secrets to Key Vault
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Key Vault name
        id: kv
        run: |
          case "${{ github.event.inputs.environment }}" in
            dev)
              echo "name=${{ env.DEV_KEY_VAULT }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "name=${{ env.STAGING_KEY_VAULT }}" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "name=${{ env.PROD_KEY_VAULT }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: List existing secrets
        if: github.event.inputs.action == 'list-secrets'
        run: |
          echo "## Existing secrets in ${{ steps.kv.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          az keyvault secret list --vault-name ${{ steps.kv.outputs.name }} --query "[].name" -o tsv | while read secret; do
            echo "- $secret" >> $GITHUB_STEP_SUMMARY
          done

      - name: Sync Entra ID secrets
        if: github.event.inputs.action == 'sync-entra-id' || github.event.inputs.action == 'sync-all'
        run: |
          echo "Syncing Entra ID configuration to Key Vault..."

          # Set Entra ID tenant and client IDs
          if [ -n "${{ secrets.ENTRA_TENANT_ID }}" ]; then
            az keyvault secret set \
              --vault-name ${{ steps.kv.outputs.name }} \
              --name "AzureAd--TenantId" \
              --value "${{ secrets.ENTRA_TENANT_ID }}" \
              --description "Azure AD Tenant ID for authentication"
            echo "✅ Set AzureAd--TenantId" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ secrets.ENTRA_ADMIN_API_CLIENT_ID }}" ]; then
            az keyvault secret set \
              --vault-name ${{ steps.kv.outputs.name }} \
              --name "AzureAd--ClientId" \
              --value "${{ secrets.ENTRA_ADMIN_API_CLIENT_ID }}" \
              --description "Admin API Client ID"
            echo "✅ Set AzureAd--ClientId" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ secrets.ENTRA_ADMIN_UI_CLIENT_ID }}" ]; then
            az keyvault secret set \
              --vault-name ${{ steps.kv.outputs.name }} \
              --name "AdminUI--ClientId" \
              --value "${{ secrets.ENTRA_ADMIN_UI_CLIENT_ID }}" \
              --description "Admin UI Client ID"
            echo "✅ Set AdminUI--ClientId" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Sync all application secrets
        if: github.event.inputs.action == 'sync-all'
        run: |
          echo "Syncing additional application secrets..."

          # Database credentials (if stored in GitHub secrets)
          if [ -n "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" ]; then
            az keyvault secret set \
              --vault-name ${{ steps.kv.outputs.name }} \
              --name "PostgreSQL--AdminPassword" \
              --value "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
              --description "PostgreSQL admin password"
            echo "✅ Set PostgreSQL--AdminPassword" >> $GITHUB_STEP_SUMMARY
          fi

          # Redis connection (if stored in GitHub secrets)
          if [ -n "${{ secrets.REDIS_CONNECTION_STRING }}" ]; then
            az keyvault secret set \
              --vault-name ${{ steps.kv.outputs.name }} \
              --name "Redis--ConnectionString" \
              --value "${{ secrets.REDIS_CONNECTION_STRING }}" \
              --description "Redis connection string"
            echo "✅ Set Redis--ConnectionString" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Secrets Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Key Vault**: ${{ steps.kv.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
