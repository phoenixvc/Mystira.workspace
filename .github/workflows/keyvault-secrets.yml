# Key Vault Secrets Management Workflow
# Syncs manual secrets from GitHub Secrets to Azure Key Vault
#
# Per ADR-0017, each service has its own Key Vault in its service-specific RG.
#
# SECRET CATEGORIES:
# 1. Auto-populated by Terraform (no action needed):
#    - postgres-connection-string, redis-connection-string, servicebus-connection-string
#    - appinsights-connection-string
#
# 2. Synced from GitHub Secrets (this workflow):
#    - AI API keys (Anthropic, OpenAI)
#    - Azure AD credentials
#    - External service credentials
#
# REQUIRED GITHUB SECRETS (per environment):
#   Story-Generator:
#     - ANTHROPIC_API_KEY_{ENV}    (e.g., ANTHROPIC_API_KEY_DEV)
#     - OPENAI_API_KEY_{ENV}
#   Admin-API:
#     - ENTRA_TENANT_ID_{ENV}
#     - ENTRA_ADMIN_API_CLIENT_ID_{ENV}
#     - ENTRA_ADMIN_UI_CLIENT_ID_{ENV}

name: Key Vault Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      service:
        description: 'Service Key Vault to manage (per ADR-0017)'
        required: true
        type: choice
        options:
          - story-generator
          - admin-api
          - publisher
          - chain
          - all
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync-manual-secrets
          - list-secrets
          - verify-secrets

permissions:
  id-token: write
  contents: read

env:
  REGION_CODE: san

jobs:
  sync-secrets:
    name: Sync Secrets to Key Vault
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Key Vault names
        id: kv
        run: |
          ENV="${{ github.event.inputs.environment }}"
          SERVICE="${{ github.event.inputs.service }}"
          REGION="${{ env.REGION_CODE }}"

          # Build Key Vault name based on service
          # Key Vault names have 24 char limit
          get_kv_name() {
            local svc=$1
            case "$svc" in
              admin-api)      echo "mys-${ENV}-adm-kv-${REGION}" ;;
              chain)          echo "mys-${ENV}-chain-kv-${REGION}" ;;
              publisher)      echo "mys-${ENV}-pub-kv-${REGION}" ;;
              story-generator) echo "mys-${ENV}-story-kv-${REGION}" ;;
            esac
          }

          if [ "$SERVICE" = "all" ]; then
            echo "admin_kv=$(get_kv_name admin-api)" >> $GITHUB_OUTPUT
            echo "chain_kv=$(get_kv_name chain)" >> $GITHUB_OUTPUT
            echo "publisher_kv=$(get_kv_name publisher)" >> $GITHUB_OUTPUT
            echo "story_kv=$(get_kv_name story-generator)" >> $GITHUB_OUTPUT
            echo "is_all=true" >> $GITHUB_OUTPUT
          else
            echo "name=$(get_kv_name "$SERVICE")" >> $GITHUB_OUTPUT
            echo "is_all=false" >> $GITHUB_OUTPUT
          fi

          echo "env_upper=$(echo $ENV | tr '[:lower:]' '[:upper:]')" >> $GITHUB_OUTPUT

      - name: List existing secrets
        if: github.event.inputs.action == 'list-secrets'
        run: |
          list_secrets() {
            local kv_name=$1
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Secrets in $kv_name" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret Name | Auto-Populated |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|----------------|" >> $GITHUB_STEP_SUMMARY
            if az keyvault show --name "$kv_name" &> /dev/null; then
              az keyvault secret list --vault-name "$kv_name" --query "[].{name:name, tags:tags}" -o json | \
                jq -r '.[] | "| \(.name) | \(if .tags.AutoPopulated == "true" then "Yes (Terraform)" else "No (Manual)" end) |"' >> $GITHUB_STEP_SUMMARY
            else
              echo "| ⚠️ Key Vault not found | - |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "# Key Vault Secrets Audit" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            list_secrets "${{ steps.kv.outputs.admin_kv }}"
            list_secrets "${{ steps.kv.outputs.chain_kv }}"
            list_secrets "${{ steps.kv.outputs.publisher_kv }}"
            list_secrets "${{ steps.kv.outputs.story_kv }}"
          else
            list_secrets "${{ steps.kv.outputs.name }}"
          fi

      - name: Sync Story-Generator secrets
        if: github.event.inputs.action == 'sync-manual-secrets' && (github.event.inputs.service == 'story-generator' || github.event.inputs.service == 'all')
        env:
          ANTHROPIC_API_KEY: ${{ secrets[format('ANTHROPIC_API_KEY_{0}', steps.kv.outputs.env_upper)] }}
          OPENAI_API_KEY: ${{ secrets[format('OPENAI_API_KEY_{0}', steps.kv.outputs.env_upper)] }}
        run: |
          KV_NAME="${{ steps.kv.outputs.is_all == 'true' && steps.kv.outputs.story_kv || steps.kv.outputs.name }}"
          echo "## Story-Generator Secrets ($KV_NAME)" >> $GITHUB_STEP_SUMMARY

          if [ -n "$ANTHROPIC_API_KEY" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "anthropic-api-key" \
              --value "$ANTHROPIC_API_KEY" \
              --content-type "api-key" \
              --tags "Source=github-secrets" "AutoPopulated=false"
            echo "✅ Set anthropic-api-key" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ ANTHROPIC_API_KEY_${{ steps.kv.outputs.env_upper }} not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$OPENAI_API_KEY" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "openai-api-key" \
              --value "$OPENAI_API_KEY" \
              --content-type "api-key" \
              --tags "Source=github-secrets" "AutoPopulated=false"
            echo "✅ Set openai-api-key" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ OPENAI_API_KEY_${{ steps.kv.outputs.env_upper }} not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Sync Admin-API secrets
        if: github.event.inputs.action == 'sync-manual-secrets' && (github.event.inputs.service == 'admin-api' || github.event.inputs.service == 'all')
        env:
          ENTRA_TENANT_ID: ${{ secrets[format('ENTRA_TENANT_ID_{0}', steps.kv.outputs.env_upper)] }}
          ENTRA_ADMIN_API_CLIENT_ID: ${{ secrets[format('ENTRA_ADMIN_API_CLIENT_ID_{0}', steps.kv.outputs.env_upper)] }}
          ENTRA_ADMIN_UI_CLIENT_ID: ${{ secrets[format('ENTRA_ADMIN_UI_CLIENT_ID_{0}', steps.kv.outputs.env_upper)] }}
        run: |
          KV_NAME="${{ steps.kv.outputs.is_all == 'true' && steps.kv.outputs.admin_kv || steps.kv.outputs.name }}"
          echo "## Admin-API Secrets ($KV_NAME)" >> $GITHUB_STEP_SUMMARY

          if [ -n "$ENTRA_TENANT_ID" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "azure-ad-tenant-id" \
              --value "$ENTRA_TENANT_ID" \
              --content-type "azure-ad" \
              --tags "Source=github-secrets" "AutoPopulated=false"
            echo "✅ Set azure-ad-tenant-id" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ ENTRA_TENANT_ID_${{ steps.kv.outputs.env_upper }} not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$ENTRA_ADMIN_API_CLIENT_ID" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "azure-ad-client-id" \
              --value "$ENTRA_ADMIN_API_CLIENT_ID" \
              --content-type "azure-ad" \
              --tags "Source=github-secrets" "AutoPopulated=false"
            echo "✅ Set azure-ad-client-id" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ ENTRA_ADMIN_API_CLIENT_ID_${{ steps.kv.outputs.env_upper }} not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$ENTRA_ADMIN_UI_CLIENT_ID" ]; then
            az keyvault secret set \
              --vault-name "$KV_NAME" \
              --name "admin-ui-client-id" \
              --value "$ENTRA_ADMIN_UI_CLIENT_ID" \
              --content-type "azure-ad" \
              --tags "Source=github-secrets" "AutoPopulated=false"
            echo "✅ Set admin-ui-client-id" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ ENTRA_ADMIN_UI_CLIENT_ID_${{ steps.kv.outputs.env_upper }} not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Sync Publisher secrets
        if: github.event.inputs.action == 'sync-manual-secrets' && (github.event.inputs.service == 'publisher' || github.event.inputs.service == 'all')
        run: |
          KV_NAME="${{ steps.kv.outputs.is_all == 'true' && steps.kv.outputs.publisher_kv || steps.kv.outputs.name }}"
          echo "## Publisher Secrets ($KV_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ All Publisher secrets are auto-populated by Terraform:" >> $GITHUB_STEP_SUMMARY
          echo "- servicebus-connection-string" >> $GITHUB_STEP_SUMMARY
          echo "- appinsights-connection-string" >> $GITHUB_STEP_SUMMARY
          echo "- chain-rpc-endpoint" >> $GITHUB_STEP_SUMMARY

      - name: Sync Chain secrets
        if: github.event.inputs.action == 'sync-manual-secrets' && (github.event.inputs.service == 'chain' || github.event.inputs.service == 'all')
        run: |
          KV_NAME="${{ steps.kv.outputs.is_all == 'true' && steps.kv.outputs.chain_kv || steps.kv.outputs.name }}"
          echo "## Chain Secrets ($KV_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ All Chain secrets are auto-populated by Terraform:" >> $GITHUB_STEP_SUMMARY
          echo "- appinsights-connection-string" >> $GITHUB_STEP_SUMMARY

      - name: Verify secrets
        if: github.event.inputs.action == 'verify-secrets'
        run: |
          verify_secret() {
            local kv_name=$1
            local secret_name=$2
            local required=$3
            if az keyvault secret show --vault-name "$kv_name" --name "$secret_name" &> /dev/null; then
              echo "| $secret_name | ✅ Present |" >> $GITHUB_STEP_SUMMARY
            elif [ "$required" = "true" ]; then
              echo "| $secret_name | ❌ Missing (Required) |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $secret_name | ⚠️ Missing (Optional) |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          verify_kv() {
            local kv_name=$1
            local service=$2
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### $service ($kv_name)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

            case "$service" in
              story-generator)
                verify_secret "$kv_name" "postgres-connection-string" "true"
                verify_secret "$kv_name" "redis-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                verify_secret "$kv_name" "anthropic-api-key" "true"
                verify_secret "$kv_name" "openai-api-key" "true"
                ;;
              admin-api)
                verify_secret "$kv_name" "postgres-connection-string" "true"
                verify_secret "$kv_name" "redis-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                verify_secret "$kv_name" "azure-ad-tenant-id" "true"
                verify_secret "$kv_name" "azure-ad-client-id" "true"
                verify_secret "$kv_name" "admin-ui-client-id" "false"
                ;;
              publisher)
                verify_secret "$kv_name" "servicebus-connection-string" "true"
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                verify_secret "$kv_name" "chain-rpc-endpoint" "true"
                ;;
              chain)
                verify_secret "$kv_name" "appinsights-connection-string" "true"
                ;;
            esac
          }

          echo "# Secrets Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.kv.outputs.is_all }}" = "true" ]; then
            verify_kv "${{ steps.kv.outputs.story_kv }}" "story-generator"
            verify_kv "${{ steps.kv.outputs.admin_kv }}" "admin-api"
            verify_kv "${{ steps.kv.outputs.publisher_kv }}" "publisher"
            verify_kv "${{ steps.kv.outputs.chain_kv }}" "chain"
          else
            verify_kv "${{ steps.kv.outputs.name }}" "${{ github.event.inputs.service }}"
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required GitHub Secrets for ${{ github.event.inputs.environment }}:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ENV_UPPER=$(echo "${{ github.event.inputs.environment }}" | tr '[:lower:]' '[:upper:]')
          echo "| Secret Name | Used By |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ANTHROPIC_API_KEY_${ENV_UPPER} | Story-Generator |" >> $GITHUB_STEP_SUMMARY
          echo "| OPENAI_API_KEY_${ENV_UPPER} | Story-Generator |" >> $GITHUB_STEP_SUMMARY
          echo "| ENTRA_TENANT_ID_${ENV_UPPER} | Admin-API |" >> $GITHUB_STEP_SUMMARY
          echo "| ENTRA_ADMIN_API_CLIENT_ID_${ENV_UPPER} | Admin-API |" >> $GITHUB_STEP_SUMMARY
          echo "| ENTRA_ADMIN_UI_CLIENT_ID_${ENV_UPPER} | Admin-API (optional) |" >> $GITHUB_STEP_SUMMARY
