name: "Shared: Publish NuGet Package"

# Mystira.Shared NuGet package publishing
# Publishes to GitHub Packages and NuGet.org
#
# Triggered by:
# - Manual workflow_dispatch
# - Changes to packages/shared (via CI trigger)
#
# See: docs/architecture/adr/0020-package-consolidation-strategy.md

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., dev.123, empty for stable)'
        required: false
        type: string
      is_prerelease:
        description: 'Is this a pre-release build?'
        required: false
        type: boolean
        default: false

  push:
    branches:
      - main
    paths:
      - 'packages/shared/**'
      - '.github/workflows/shared-publish.yml'

concurrency:
  group: shared-nuget-publish
  cancel-in-progress: false

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  PACKAGE_PATH: packages/shared/Mystira.Shared

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore ${{ env.PACKAGE_PATH }}

      - name: Build
        run: dotnet build ${{ env.PACKAGE_PATH }} --configuration Release --no-restore

      # Note: Add tests when available
      # - name: Test
      #   run: dotnet test ${{ env.PACKAGE_PATH }} --configuration Release --no-build

  publish:
    name: Publish NuGet Package
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only publish on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.pack.outputs.version }}
      package_name: ${{ steps.pack.outputs.package_name }}

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Determine version details
        id: version
        run: |
          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          IS_PRERELEASE="${{ github.event.inputs.is_prerelease || 'false' }}"

          echo "version_suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          if [ -n "$VERSION_SUFFIX" ] || [ "$IS_PRERELEASE" = "true" ]; then
            echo "publish_to_nuget_org=false" >> $GITHUB_OUTPUT
          else
            echo "publish_to_nuget_org=true" >> $GITHUB_OUTPUT
          fi

      - name: Restore dependencies
        run: dotnet restore ${{ env.PACKAGE_PATH }}

      - name: Build
        run: dotnet build ${{ env.PACKAGE_PATH }} --configuration Release --no-restore

      - name: Pack NuGet package
        id: pack
        run: |
          PACK_ARGS="--configuration Release --no-build --output ./nupkg"

          if [ -n "${{ steps.version.outputs.version_suffix }}" ]; then
            PACK_ARGS="$PACK_ARGS --version-suffix ${{ steps.version.outputs.version_suffix }}"
          fi

          dotnet pack ${{ env.PACKAGE_PATH }} $PACK_ARGS

          # Get the package info
          NUPKG_FILE=$(ls ./nupkg/*.nupkg | head -1)
          PACKAGE_NAME=$(basename "$NUPKG_FILE" .nupkg | sed 's/\.[0-9].*//')
          PACKAGE_VERSION=$(basename "$NUPKG_FILE" .nupkg | sed "s/${PACKAGE_NAME}\.//")

          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://nuget.pkg.github.com/phoenixvc/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Push to NuGet.org (stable releases only)
        if: steps.version.outputs.publish_to_nuget_org == 'true'
        run: |
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: Generate summary
        run: |
          echo "## Mystira.Shared NuGet Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | ${{ steps.pack.outputs.package_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.pack.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.version.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Packages: \`https://nuget.pkg.github.com/phoenixvc/index.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.publish_to_nuget_org }}" = "true" ]; then
            echo "- NuGet.org: \`https://www.nuget.org/packages/Mystira.Shared\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package Mystira.Shared --version ${{ steps.pack.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Replaces" >> $GITHUB_STEP_SUMMARY
          echo "This package replaces \`Mystira.App.Shared\` (deprecated)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Migration Guide](packages/shared/Mystira.Shared/README.md) for upgrade instructions." >> $GITHUB_STEP_SUMMARY
