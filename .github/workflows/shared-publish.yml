name: "Publish: Shared (NuGet)"

# Mystira.Shared NuGet package publishing
# Publishes to GitHub Packages and NuGet.org
#
# Triggered by:
# - Push to dev branch (publishes pre-release: 1.0.0-dev.123)
# - Push to main branch (publishes stable: 1.0.0)
# - Manual workflow_dispatch
#
# Version Strategy:
# - Dev push: Pre-release to GitHub Packages only (e.g., 1.0.0-dev.123)
# - Main push: Stable to GitHub Packages + NuGet.org (e.g., 1.0.0)
#
# See: docs/architecture/adr/0020-package-consolidation-strategy.md

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'packages/shared/**'
      - '.github/workflows/shared-publish.yml'

  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., beta.1, rc.1 - leave empty for stable)'
        required: false
        type: string
      publish_to_nuget_org:
        description: 'Also publish to NuGet.org (uncheck for GitHub Packages only)'
        required: false
        type: boolean
        default: true

concurrency:
  group: shared-nuget-publish
  cancel-in-progress: false

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  PACKAGE_PATH: packages/shared/Mystira.Shared

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  # Publish Contracts first since Shared depends on it
  publish-contracts:
    name: Publish Contracts (dependency)
    uses: ./.github/workflows/contracts-publish.yml
    secrets: inherit

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: publish-contracts
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Restore dependencies
        run: |
          dotnet restore ${{ env.PACKAGE_PATH }}
          dotnet restore packages/shared/Mystira.Shared.Tests
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        run: |
          dotnet build ${{ env.PACKAGE_PATH }} --configuration Release --no-restore
          dotnet build packages/shared/Mystira.Shared.Tests --configuration Release --no-restore

      - name: Test with Coverage
        run: |
          dotnet test packages/shared/Mystira.Shared.Tests \
            --configuration Release \
            --no-restore \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          directory: ./coverage
          files: "**/coverage.cobertura.xml"
          flags: mystira-shared
          name: mystira-shared-coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  publish:
    name: Publish NuGet Package
    runs-on: ubuntu-latest
    needs: build-and-test
    # Publish on dev (pre-release), main (stable), or manual trigger
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.pack.outputs.version }}
      package_name: ${{ steps.pack.outputs.package_name }}

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Determine version details
        id: version
        run: |
          # Determine version suffix and settings based on trigger
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Main push: stable release (no suffix) to both registries
            VERSION_SUFFIX=""
            IS_PRERELEASE="false"
            PUBLISH_TO_NUGET_ORG="true"
            TRIGGER_SOURCE="main-push"
          else
            # All other triggers: use build.123 format for consistency
            VERSION_SUFFIX="build.${{ github.run_number }}"
            IS_PRERELEASE="true"
            if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/dev" ]; then
              PUBLISH_TO_NUGET_ORG="false"
              TRIGGER_SOURCE="dev-push"
            else
              PUBLISH_TO_NUGET_ORG="${{ github.event.inputs.publish_to_nuget_org }}"
              TRIGGER_SOURCE="manual"
            fi
          fi

          echo "version_suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "trigger_source=$TRIGGER_SOURCE" >> $GITHUB_OUTPUT
          echo "publish_to_nuget_org=$PUBLISH_TO_NUGET_ORG" >> $GITHUB_OUTPUT

      - name: Restore dependencies
        run: dotnet restore ${{ env.PACKAGE_PATH }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read version from .csproj
        id: csproj_version
        run: |
          # Read base version from .csproj
          BASE_VERSION=$(grep -oP '(?<=<Version>)[^<]+' ${{ env.PACKAGE_PATH }}/Mystira.Shared.csproj)
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base version from .csproj: $BASE_VERSION"

          # Calculate full version with suffix if applicable
          VERSION_SUFFIX="${{ steps.version.outputs.version_suffix }}"
          if [ -n "$VERSION_SUFFIX" ]; then
            FULL_VERSION="${BASE_VERSION}-${VERSION_SUFFIX}"
          else
            FULL_VERSION="$BASE_VERSION"
          fi

          # Ensure version contains 'alpha' for NuGet.org API key permissions
          # The API key only allows pushing packages matching *alpha* pattern
          if [[ ! "$FULL_VERSION" == *"alpha"* ]]; then
            FULL_VERSION="${FULL_VERSION}-alpha"
            echo "Added alpha suffix for NuGet.org compatibility"
          fi

          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Full NuGet version: $FULL_VERSION"

      - name: Build
        run: |
          dotnet build ${{ env.PACKAGE_PATH }} --configuration Release --no-restore \
            -p:Version=${{ steps.csproj_version.outputs.full_version }}

      - name: Pack NuGet package
        id: pack
        run: |
          # Use calculated version (base from .csproj + suffix if applicable)
          dotnet pack ${{ env.PACKAGE_PATH }} \
            --configuration Release \
            --no-build \
            --output ./nupkg \
            -p:Version=${{ steps.csproj_version.outputs.full_version }}

          # Output package info (hardcoded - we know the package name)
          echo "version=${{ steps.csproj_version.outputs.full_version }}" >> $GITHUB_OUTPUT
          echo "package_name=Mystira.Shared" >> $GITHUB_OUTPUT
          echo "Packed Mystira.Shared v${{ steps.csproj_version.outputs.full_version }}"

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://nuget.pkg.github.com/phoenixvc/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Push to NuGet.org (stable releases only)
        if: steps.version.outputs.publish_to_nuget_org == 'true'
        run: |
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: Generate summary
        run: |
          echo "## Mystira.Shared NuGet Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | ${{ steps.pack.outputs.package_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.pack.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.version.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ steps.version.outputs.trigger_source }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Packages: \`https://nuget.pkg.github.com/phoenixvc/index.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.publish_to_nuget_org }}" = "true" ]; then
            echo "- NuGet.org: \`https://www.nuget.org/packages/Mystira.Shared\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package Mystira.Shared --version ${{ steps.pack.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Replaces" >> $GITHUB_STEP_SUMMARY
          echo "This package replaces \`Mystira.App.Shared\` (deprecated)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Migration Guide](packages/shared/Mystira.Shared/README.md) for upgrade instructions." >> $GITHUB_STEP_SUMMARY
