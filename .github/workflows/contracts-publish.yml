name: "Packages - Contracts: Publish NuGet"

# Unified contracts NuGet package publishing
# Publishes Mystira.Contracts to GitHub Packages and NuGet.org
#
# Note: NPM publishing (@mystira/contracts) is handled by Changesets in release.yml
# This workflow only handles the corresponding NuGet package
#
# Triggered by:
# - Push to dev branch (publishes pre-release: 1.0.0-dev.123)
# - repository_dispatch from release.yml after @mystira/contracts NPM publish (stable)
# - Manual workflow_dispatch
#
# Version Strategy:
# - Dev push: Pre-release to GitHub Packages only (e.g., 1.0.0-dev.123)
# - Main/Changesets: Stable to GitHub Packages + NuGet.org (e.g., 1.0.0)
#
# See: docs/architecture/adr/0020-package-consolidation-strategy.md

on:
  push:
    branches:
      - dev
    paths:
      - 'packages/contracts/dotnet/**'
      - '.github/workflows/contracts-publish.yml'

  repository_dispatch:
    types:
      - contracts-nuget-publish

  # Allow being called from shared-publish workflow
  workflow_call:
    outputs:
      version:
        description: "Published package version"
        value: ${{ jobs.publish-nuget.outputs.version }}

  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., beta.1, rc.1 - leave empty for stable)'
        required: false
        type: string
      publish_to_nuget_org:
        description: 'Also publish to NuGet.org (uncheck for GitHub Packages only)'
        required: false
        type: boolean
        default: true

concurrency:
  group: contracts-nuget-publish
  cancel-in-progress: false

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  publish-nuget:
    name: Publish Mystira.Contracts NuGet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v6

      - name: Determine version details
        id: version
        run: |
          # Always use build.123 format for consistency
          VERSION_SUFFIX="build.${{ github.run_number }}"

          # Determine other settings based on trigger
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            IS_PRERELEASE="true"
            PUBLISH_TO_NUGET_ORG="false"
            TRIGGER_SOURCE="dev-push"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IS_PRERELEASE="true"
            PUBLISH_TO_NUGET_ORG="${{ github.event.inputs.publish_to_nuget_org }}"
            TRIGGER_SOURCE="manual"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            IS_PRERELEASE="${{ github.event.client_payload.is_prerelease || 'true' }}"
            PUBLISH_TO_NUGET_ORG="${{ github.event.client_payload.publish_to_nuget_org || 'true' }}"
            TRIGGER_SOURCE="${{ github.event.client_payload.triggered_by || 'changesets' }}"
          else
            IS_PRERELEASE="true"
            PUBLISH_TO_NUGET_ORG="false"
            TRIGGER_SOURCE="workflow-call"
          fi

          echo "version_suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "trigger_source=$TRIGGER_SOURCE" >> $GITHUB_OUTPUT
          echo "publish_to_nuget_org=$PUBLISH_TO_NUGET_ORG" >> $GITHUB_OUTPUT

      - name: Read version from package.json (NPM source of truth)
        id: npm_version
        run: |
          # Read base version from NPM package.json (managed by Changesets)
          BASE_VERSION=$(jq -r '.version' packages/contracts/package.json)
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base version from package.json: $BASE_VERSION"

          # Calculate full version with suffix if applicable
          VERSION_SUFFIX="${{ steps.version.outputs.version_suffix }}"
          if [ -n "$VERSION_SUFFIX" ]; then
            FULL_VERSION="${BASE_VERSION}-${VERSION_SUFFIX}"
          else
            FULL_VERSION="$BASE_VERSION"
          fi

          # Ensure version contains 'alpha' for NuGet.org API key permissions
          # The API key only allows pushing packages matching *alpha* pattern
          if [[ ! "$FULL_VERSION" == *"alpha"* ]]; then
            FULL_VERSION="${FULL_VERSION}-alpha"
            echo "Added alpha suffix for NuGet.org compatibility"
          fi

          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Full NuGet version: $FULL_VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Restore dependencies
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet restore
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Build
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          # Override version from package.json to keep NPM and NuGet in sync
          dotnet build --configuration Release --no-restore \
            -p:Version=${{ steps.npm_version.outputs.full_version }}

      - name: Pack NuGet package
        id: pack
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts

          # Use version from package.json (synced with NPM via Changesets)
          # Full version already includes suffix if applicable
          dotnet pack --configuration Release --no-build --output ./nupkg \
            -p:Version=${{ steps.npm_version.outputs.full_version }}

          # Output the version we just packed
          echo "version=${{ steps.npm_version.outputs.full_version }}" >> $GITHUB_OUTPUT
          echo "Packed Mystira.Contracts v${{ steps.npm_version.outputs.full_version }}"

      - name: List package contents
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          echo "=== Source Files Included ==="
          find . -name "*.cs" -type f | sort
          echo ""
          echo "=== Namespaces & Types ==="
          # Extract all public types from source files
          grep -rh "^public \(class\|record\|interface\|enum\|struct\)" --include="*.cs" . | \
            sed 's/^public //' | \
            sed 's/{.*//' | \
            sed 's/ :.*//' | \
            sort | uniq
          echo ""
          echo "=== Package Files ==="
          unzip -l ./nupkg/*.nupkg | grep -E "\.dll|\.xml|\.pdb" || true

      - name: Push to GitHub Packages
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://nuget.pkg.github.com/phoenixvc/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Push to NuGet.org (stable releases only)
        if: steps.version.outputs.publish_to_nuget_org == 'true'
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: Generate summary
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts

          echo "## Mystira.Contracts NuGet Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Mystira.Contracts |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.pack.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.version.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ steps.version.outputs.trigger_source }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Types Included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to expand type list</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          # List all public types by namespace
          for ns in App App/Responses/Badges App/Responses/Common App/Ports/Health StoryGenerator; do
            if [ -d "$ns" ]; then
              echo "# Mystira.Contracts.${ns//\//.}" >> $GITHUB_STEP_SUMMARY
              grep -rh "^public \(class\|record\|interface\|enum\|struct\)" --include="*.cs" "$ns" 2>/dev/null | \
                sed 's/^public /  - /' | \
                sed 's/{.*//' | \
                sed 's/ :.*//' | \
                sort | uniq >> $GITHUB_STEP_SUMMARY || true
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Packages: \`https://nuget.pkg.github.com/phoenixvc/index.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.publish_to_nuget_org }}" = "true" ]; then
            echo "- NuGet.org: \`https://www.nuget.org/packages/Mystira.Contracts\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unified Contracts Package" >> $GITHUB_STEP_SUMMARY
          echo "This package replaces:" >> $GITHUB_STEP_SUMMARY
          echo "- \`Mystira.App.Contracts\` → \`Mystira.Contracts.App\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`Mystira.StoryGenerator.Contracts\` → \`Mystira.Contracts.StoryGenerator\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Migration Guide](docs/guides/contracts-migration.md) for upgrade instructions." >> $GITHUB_STEP_SUMMARY

    outputs:
      version: ${{ steps.pack.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
