name: "Packages - Contracts: Publish NuGet"

# Unified contracts NuGet package publishing
# Publishes Mystira.Contracts to GitHub Packages and NuGet.org
#
# Note: NPM publishing (@mystira/contracts) is handled by Changesets in release.yml
# This workflow only handles the corresponding NuGet package
#
# Triggered by:
# - Push to dev branch (publishes pre-release: 1.0.0-dev.123)
# - repository_dispatch from release.yml after @mystira/contracts NPM publish (stable)
# - Manual workflow_dispatch
#
# Version Strategy:
# - Dev push: Pre-release to GitHub Packages only (e.g., 1.0.0-dev.123)
# - Main/Changesets: Stable to GitHub Packages + NuGet.org (e.g., 1.0.0)
#
# See: docs/architecture/adr/0020-package-consolidation-strategy.md

on:
  push:
    branches:
      - dev
    paths:
      - 'packages/contracts/dotnet/**'
      - '.github/workflows/contracts-publish.yml'

  repository_dispatch:
    types:
      - contracts-nuget-publish

  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., beta.1, rc.1 - leave empty for stable)'
        required: false
        type: string
      publish_to_nuget_org:
        description: 'Also publish to NuGet.org (uncheck for GitHub Packages only)'
        required: false
        type: boolean
        default: true

concurrency:
  group: contracts-nuget-publish
  cancel-in-progress: false

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  publish-nuget:
    name: Publish Mystira.Contracts NuGet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v4

      - name: Determine version details
        id: version
        run: |
          # Check if this is a dev branch push
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            # Dev push: generate pre-release version suffix, GitHub Packages only
            VERSION_SUFFIX="dev.${{ github.run_number }}"
            IS_PRERELEASE="true"
            PUBLISH_TO_NUGET_ORG="false"
            TRIGGER_SOURCE="dev-push"
            echo "Dev branch push detected - publishing pre-release to GitHub Packages only"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: user controls everything
            VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
            IS_PRERELEASE="${{ github.event.inputs.version_suffix && 'true' || 'false' }}"
            PUBLISH_TO_NUGET_ORG="${{ github.event.inputs.publish_to_nuget_org }}"
            TRIGGER_SOURCE="manual"
            echo "Manual trigger - publishing to $([ "$PUBLISH_TO_NUGET_ORG" = "true" ] && echo "GitHub + NuGet.org" || echo "GitHub Packages only")"
          else
            # repository_dispatch (from Changesets release)
            VERSION_SUFFIX="${{ github.event.client_payload.version_suffix }}"
            IS_PRERELEASE="${{ github.event.client_payload.is_prerelease || 'false' }}"
            PUBLISH_TO_NUGET_ORG="${{ github.event.client_payload.publish_to_nuget_org || 'true' }}"
            TRIGGER_SOURCE="${{ github.event.client_payload.triggered_by || 'changesets' }}"
          fi

          echo "version_suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "trigger_source=$TRIGGER_SOURCE" >> $GITHUB_OUTPUT
          echo "publish_to_nuget_org=$PUBLISH_TO_NUGET_ORG" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet restore
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Build
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet build --configuration Release --no-restore

      - name: Pack NuGet package
        id: pack
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts

          PACK_ARGS="--configuration Release --no-build --output ./nupkg"

          if [ -n "${{ steps.version.outputs.version_suffix }}" ]; then
            PACK_ARGS="$PACK_ARGS --version-suffix ${{ steps.version.outputs.version_suffix }}"
          fi

          dotnet pack $PACK_ARGS

          # Get the package version
          NUPKG_FILE=$(ls ./nupkg/*.nupkg | head -1)
          PACKAGE_VERSION=$(basename "$NUPKG_FILE" .nupkg | sed "s/Mystira.Contracts\.//")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Push to GitHub Packages
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://nuget.pkg.github.com/phoenixvc/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Push to NuGet.org (stable releases only)
        if: steps.version.outputs.publish_to_nuget_org == 'true'
        run: |
          cd packages/contracts/dotnet/Mystira.Contracts
          dotnet nuget push "./nupkg/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: Generate summary
        run: |
          echo "## Mystira.Contracts NuGet Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Mystira.Contracts |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.pack.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.version.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ steps.version.outputs.trigger_source }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Packages: \`https://nuget.pkg.github.com/phoenixvc/index.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.publish_to_nuget_org }}" = "true" ]; then
            echo "- NuGet.org: \`https://www.nuget.org/packages/Mystira.Contracts\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unified Contracts Package" >> $GITHUB_STEP_SUMMARY
          echo "This package replaces:" >> $GITHUB_STEP_SUMMARY
          echo "- \`Mystira.App.Contracts\` → \`Mystira.Contracts.App\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`Mystira.StoryGenerator.Contracts\` → \`Mystira.Contracts.StoryGenerator\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Migration Guide](docs/guides/contracts-migration.md) for upgrade instructions." >> $GITHUB_STEP_SUMMARY

    outputs:
      version: ${{ steps.pack.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
