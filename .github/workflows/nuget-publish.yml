name: "NuGet: Publish Packages"

# Unified NuGet package publishing
# Triggered by:
# - Submodule repository_dispatch (preserves existing mechanism)
# - Changesets release workflow (unified versioning)
# - Manual workflow_dispatch
#
# Version Strategy:
# - Dev push: Pre-release version (e.g., 1.0.0-dev.123)
# - Main push / Changesets: Stable version (e.g., 1.0.0)

on:
  repository_dispatch:
    types:
      - nuget-publish

  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        type: choice
        options:
          - app-contracts
          - story-generator-contracts
      version_suffix:
        description: 'Version suffix (e.g., dev.123, empty for stable)'
        required: false
        type: string
      source_ref:
        description: 'Source commit SHA'
        required: false
        type: string

concurrency:
  group: nuget-publish-${{ github.event.client_payload.package || github.event.inputs.package }}
  cancel-in-progress: false

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  id-token: write
  contents: write
  packages: write

jobs:
  publish:
    name: Publish NuGet Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.MYSTIRA_GITHUB_SUBMODULE_ACCESS_TOKEN }}

      - name: Determine package details
        id: package
        run: |
          PACKAGE="${{ github.event.client_payload.package || github.event.inputs.package }}"
          VERSION_SUFFIX="${{ github.event.client_payload.version_suffix || github.event.inputs.version_suffix }}"
          SOURCE_REF="${{ github.event.client_payload.ref || github.event.inputs.source_ref }}"
          IS_PRERELEASE="${{ github.event.client_payload.is_prerelease || 'false' }}"

          case "$PACKAGE" in
            app-contracts)
              echo "submodule_path=packages/app" >> $GITHUB_OUTPUT
              echo "project_path=src/Mystira.App.Contracts/Mystira.App.Contracts.csproj" >> $GITHUB_OUTPUT
              echo "package_name=Mystira.App.Contracts" >> $GITHUB_OUTPUT
              ;;
            story-generator-contracts)
              echo "submodule_path=packages/story-generator" >> $GITHUB_OUTPUT
              echo "project_path=src/Mystira.StoryGenerator.Contracts/Mystira.StoryGenerator.Contracts.csproj" >> $GITHUB_OUTPUT
              echo "package_name=Mystira.StoryGenerator.Contracts" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "::error::Unknown package: $PACKAGE"
              exit 1
              ;;
          esac

          echo "package=$PACKAGE" >> $GITHUB_OUTPUT
          echo "version_suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "source_ref=$SOURCE_REF" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Update submodule to source ref
        if: steps.package.outputs.source_ref != ''
        run: |
          cd ${{ steps.package.outputs.submodule_path }}
          git fetch origin
          git checkout ${{ steps.package.outputs.source_ref }}
          echo "Checked out: $(git rev-parse HEAD)"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: |
          cd ${{ steps.package.outputs.submodule_path }}
          dotnet restore ${{ steps.package.outputs.project_path }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Build
        run: |
          cd ${{ steps.package.outputs.submodule_path }}
          dotnet build ${{ steps.package.outputs.project_path }} \
            --configuration Release \
            --no-restore

      - name: Pack NuGet package
        id: pack
        run: |
          cd ${{ steps.package.outputs.submodule_path }}

          PACK_ARGS="--configuration Release --no-build --output ./nupkg"

          if [ -n "${{ steps.package.outputs.version_suffix }}" ]; then
            PACK_ARGS="$PACK_ARGS --version-suffix ${{ steps.package.outputs.version_suffix }}"
          fi

          dotnet pack ${{ steps.package.outputs.project_path }} $PACK_ARGS

          # Get the package version
          NUPKG_FILE=$(ls ./nupkg/*.nupkg | head -1)
          PACKAGE_VERSION=$(basename "$NUPKG_FILE" .nupkg | sed "s/${{ steps.package.outputs.package_name }}\.//")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "nupkg_path=${{ steps.package.outputs.submodule_path }}/nupkg" >> $GITHUB_OUTPUT

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push "${{ steps.pack.outputs.nupkg_path }}/*.nupkg" \
            --source "https://nuget.pkg.github.com/phoenixvc/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Push to NuGet.org (stable releases only)
        if: steps.package.outputs.is_prerelease != 'true' && steps.package.outputs.version_suffix == ''
        run: |
          dotnet nuget push "${{ steps.pack.outputs.nupkg_path }}/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: Generate summary
        run: |
          TRIGGER_SOURCE="${{ github.event.client_payload.triggered_by || github.event.client_payload.source || 'manual' }}"

          echo "## NuGet Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | ${{ steps.package.outputs.package_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.pack.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.package.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Ref | ${{ steps.package.outputs.source_ref || 'latest' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${TRIGGER_SOURCE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Packages: \`https://nuget.pkg.github.com/phoenixvc/index.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.package.outputs.is_prerelease }}" != "true" ] && [ -z "${{ steps.package.outputs.version_suffix }}" ]; then
            echo "- NuGet.org: \`https://www.nuget.org/packages/${{ steps.package.outputs.package_name }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unified Publishing" >> $GITHUB_STEP_SUMMARY
          echo "This package was published as part of the unified release process." >> $GITHUB_STEP_SUMMARY
          echo "See [Publishing Guide](docs/guides/package-releases.md) for more information." >> $GITHUB_STEP_SUMMARY

    outputs:
      package: ${{ steps.package.outputs.package }}
      package_name: ${{ steps.package.outputs.package_name }}
      version: ${{ steps.pack.outputs.version }}
      is_prerelease: ${{ steps.package.outputs.is_prerelease }}
      version_suffix: ${{ steps.package.outputs.version_suffix }}

  # Create changeset for dependent NPM packages after stable NuGet publish
  # Only runs for submodule-triggered publishes (not Changesets-triggered to avoid loops)
  create-changeset:
    name: Create Changeset for NPM Dependencies
    runs-on: ubuntu-latest
    needs: publish
    # Only for stable releases triggered by submodules (not from unified workflow)
    if: |
      needs.publish.outputs.is_prerelease != 'true' &&
      needs.publish.outputs.version_suffix == '' &&
      github.event.client_payload.triggered_by != 'changesets-release'
    steps:
      - name: Checkout workspace
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MYSTIRA_GITHUB_SUBMODULE_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Determine dependent NPM package
        id: npm_package
        run: |
          case "${{ needs.publish.outputs.package }}" in
            app-contracts)
              echo "npm_package=@mystira/app" >> $GITHUB_OUTPUT
              echo "description=Update Mystira.App.Contracts dependency" >> $GITHUB_OUTPUT
              ;;
            story-generator-contracts)
              echo "npm_package=@mystira/story-generator" >> $GITHUB_OUTPUT
              echo "description=Update Mystira.StoryGenerator.Contracts dependency" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "npm_package=" >> $GITHUB_OUTPUT
              echo "No dependent NPM package for ${{ needs.publish.outputs.package }}"
              ;;
          esac

      - name: Create changeset file
        if: steps.npm_package.outputs.npm_package != ''
        id: changeset
        run: |
          # Generate a unique branch name
          SHORT_ID=$(echo "${{ github.run_id }}" | tail -c 9)
          BRANCH_NAME="nuget-changeset-${SHORT_ID}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # Generate a random changeset name
          CHANGESET_NAME="nuget-$(echo $RANDOM | md5sum | head -c 8)"
          CHANGESET_FILE=".changeset/${CHANGESET_NAME}.md"
          echo "changeset_file=${CHANGESET_FILE}" >> $GITHUB_OUTPUT

          # Create the changeset using printf to avoid YAML parsing issues with ---
          printf '%s\n' \
            '---' \
            "\"${{ steps.npm_package.outputs.npm_package }}\": patch" \
            '---' \
            '' \
            "${{ steps.npm_package.outputs.description }} to version ${{ needs.publish.outputs.version }}." \
            '' \
            "This changeset was auto-generated after NuGet package \`${{ needs.publish.outputs.package_name }}\` was published." \
            > "$CHANGESET_FILE"

          echo "Created changeset: $CHANGESET_FILE"
          cat "$CHANGESET_FILE"

      - name: Create branch and commit changeset
        if: steps.npm_package.outputs.npm_package != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and switch to new branch
          git checkout -b ${{ steps.changeset.outputs.branch_name }}

          # Commit the changeset
          git add .changeset/*.md
          git commit -m "chore: add changeset for ${{ needs.publish.outputs.package_name }} v${{ needs.publish.outputs.version }}"

          # Push the branch
          git push origin ${{ steps.changeset.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.npm_package.outputs.npm_package != ''
        env:
          GH_TOKEN: ${{ secrets.MYSTIRA_GITHUB_SUBMODULE_ACCESS_TOKEN }}
          PACKAGE_NAME: ${{ needs.publish.outputs.package_name }}
          VERSION: ${{ needs.publish.outputs.version }}
          NPM_PACKAGE: ${{ steps.npm_package.outputs.npm_package }}
          BRANCH_NAME: ${{ steps.changeset.outputs.branch_name }}
        run: |
          gh pr create \
            --title "chore: add changeset for ${PACKAGE_NAME} v${VERSION}" \
            --body "## Auto-generated Changeset

This PR was automatically created after NuGet package **${PACKAGE_NAME}** v${VERSION} was published.

### Changes
- Adds a changeset to bump **${NPM_PACKAGE}** (patch)

### Why
This ensures NPM packages stay in sync with their corresponding NuGet packages.

### Next Steps
1. Review and merge this PR
2. The Changesets release workflow will create a version PR
3. Merge the version PR to publish the NPM package

---
*This PR was auto-generated by the NuGet publish workflow.*" \
            --base main \
            --head "${BRANCH_NAME}"

      - name: Summary
        if: steps.npm_package.outputs.npm_package != ''
        env:
          NPM_PACKAGE: ${{ steps.npm_package.outputs.npm_package }}
          PACKAGE_NAME: ${{ needs.publish.outputs.package_name }}
          VERSION: ${{ needs.publish.outputs.version }}
          BRANCH_NAME: ${{ steps.changeset.outputs.branch_name }}
        run: |
          echo "## Changeset PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request was created with a changeset to bump **${NPM_PACKAGE}** after NuGet package **${PACKAGE_NAME}** v${VERSION} was published." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${BRANCH_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Once the PR is merged, the Changesets release workflow will create a version PR." >> $GITHUB_STEP_SUMMARY
