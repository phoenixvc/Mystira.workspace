name: "Mystira App API: Production Blue-Green Deployment"

# Production Blue-Green Deployment for Mystira App API
# Strategy: Deploy to staging slot, health check, then swap to production
# Features:
#   - Staging slot deployment for zero-downtime releases
#   - Automated health checks before swap
#   - Configurable warm-up time
#   - Automatic rollback trigger conditions
# Environment: https://mystira.app/api

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string
      skip_health_check:
        description: 'Skip health checks (emergency only)'
        required: false
        type: boolean
        default: false
      warm_up_seconds:
        description: 'Warm-up time in seconds before swap'
        required: false
        type: number
        default: 60

concurrency:
  group: mystira-app-api-prod
  cancel-in-progress: false

env:
  AZURE_RESOURCE_GROUP: mys-prod-core-rg-san
  APP_SERVICE_NAME: mys-prod-app-api-san
  STAGING_SLOT: staging
  PRODUCTION_SLOT: production
  HEALTH_CHECK_ENDPOINT: /health
  HEALTH_CHECK_TIMEOUT: 120
  MIN_HEALTHY_CHECKS: 3

jobs:
  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    outputs:
      deployment_id: ${{ steps.generate_id.outputs.deployment_id }}
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'DEPLOY TO PRODUCTION'
        run: |
          echo "::error::Invalid confirmation. You must type 'DEPLOY TO PRODUCTION' exactly."
          exit 1

      - name: Generate deployment ID
        id: generate_id
        run: |
          DEPLOYMENT_ID="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER}"
          echo "deployment_id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "## Deployment ID: ${DEPLOYMENT_ID}" >> $GITHUB_STEP_SUMMARY

  deploy-to-staging-slot:
    name: Deploy to Staging Slot
    runs-on: ubuntu-latest
    needs: [validate-confirmation]
    environment:
      name: production-staging
      url: https://${{ env.APP_SERVICE_NAME }}-${{ env.STAGING_SLOT }}.azurewebsites.net
    permissions:
      contents: read
      id-token: write
    outputs:
      staging_url: ${{ steps.deploy.outputs.staging_url }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          ref: main

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
          source-url: https://nuget.pkg.github.com/phoenixvc/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Build Application
        run: |
          cd packages/app
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --no-build --output ./publish
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Deploy to Staging Slot
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_SERVICE_NAME }}
          slot-name: ${{ env.STAGING_SLOT }}
          package: packages/app/publish

      - name: Set staging URL output
        run: |
          STAGING_URL="https://${{ env.APP_SERVICE_NAME }}-${{ env.STAGING_SLOT }}.azurewebsites.net"
          echo "staging_url=${STAGING_URL}" >> $GITHUB_OUTPUT
          echo "## Deployed to Staging" >> $GITHUB_STEP_SUMMARY
          echo "URL: ${STAGING_URL}" >> $GITHUB_STEP_SUMMARY

  health-check-staging:
    name: Health Check Staging Slot
    runs-on: ubuntu-latest
    needs: [deploy-to-staging-slot]
    if: ${{ github.event.inputs.skip_health_check != 'true' }}
    steps:
      - name: Wait for application startup
        run: |
          echo "Waiting ${{ github.event.inputs.warm_up_seconds || 60 }} seconds for application warm-up..."
          sleep ${{ github.event.inputs.warm_up_seconds || 60 }}

      - name: Health check - staging slot
        id: health_check
        run: |
          STAGING_URL="https://${{ env.APP_SERVICE_NAME }}-${{ env.STAGING_SLOT }}.azurewebsites.net"
          HEALTH_URL="${STAGING_URL}${{ env.HEALTH_CHECK_ENDPOINT }}"

          echo "Running health checks against: ${HEALTH_URL}"
          echo "## Health Check Results" >> $GITHUB_STEP_SUMMARY

          HEALTHY_COUNT=0
          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${HEALTH_URL}" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
              echo "- Attempt ${ATTEMPT}: HTTP ${HTTP_STATUS}" >> $GITHUB_STEP_SUMMARY

              if [ $HEALTHY_COUNT -ge ${{ env.MIN_HEALTHY_CHECKS }} ]; then
                echo "Staging slot is healthy (${HEALTHY_COUNT} consecutive successful checks)"
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Result: HEALTHY** (${HEALTHY_COUNT} consecutive checks)" >> $GITHUB_STEP_SUMMARY
                exit 0
              fi
            else
              HEALTHY_COUNT=0
              echo "- Attempt ${ATTEMPT}: HTTP ${HTTP_STATUS} (reset count)" >> $GITHUB_STEP_SUMMARY
            fi

            sleep 10
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Result: UNHEALTHY** - Failed to get ${{ env.MIN_HEALTHY_CHECKS }} consecutive successful checks" >> $GITHUB_STEP_SUMMARY
          echo "::error::Health check failed after ${MAX_ATTEMPTS} attempts"
          exit 1

      - name: Verify readiness endpoints
        run: |
          STAGING_URL="https://${{ env.APP_SERVICE_NAME }}-${{ env.STAGING_SLOT }}.azurewebsites.net"

          echo "### Additional Readiness Checks" >> $GITHUB_STEP_SUMMARY

          # Check /ready endpoint if available
          READY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${STAGING_URL}/ready" || echo "N/A")
          echo "- /ready: HTTP ${READY_STATUS}" >> $GITHUB_STEP_SUMMARY

          # Check /live endpoint if available
          LIVE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${STAGING_URL}/live" || echo "N/A")
          echo "- /live: HTTP ${LIVE_STATUS}" >> $GITHUB_STEP_SUMMARY

          # Check API version endpoint
          VERSION_RESPONSE=$(curl -s --max-time 30 "${STAGING_URL}/api/version" 2>/dev/null || echo "{}")
          echo "- /api/version: ${VERSION_RESPONSE}" >> $GITHUB_STEP_SUMMARY

  swap-to-production:
    name: Swap Staging to Production
    runs-on: ubuntu-latest
    needs: [validate-confirmation, deploy-to-staging-slot, health-check-staging]
    if: ${{ always() && needs.deploy-to-staging-slot.result == 'success' && (needs.health-check-staging.result == 'success' || needs.health-check-staging.result == 'skipped') }}
    environment:
      name: production
      url: https://mystira.app/api
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Record pre-swap state
        id: pre_swap
        run: |
          echo "Recording pre-swap production state for potential rollback..."

          # Get current production slot configuration
          PROD_CONFIG=$(az webapp config show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.APP_SERVICE_NAME }} \
            --slot ${{ env.PRODUCTION_SLOT }} 2>/dev/null || echo "{}")

          echo "## Pre-Swap State" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "Deployment ID: ${{ needs.validate-confirmation.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Swap staging to production
        id: swap
        run: |
          echo "Initiating slot swap: ${{ env.STAGING_SLOT }} -> ${{ env.PRODUCTION_SLOT }}"

          SWAP_START=$(date +%s)

          az webapp deployment slot swap \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.APP_SERVICE_NAME }} \
            --slot ${{ env.STAGING_SLOT }} \
            --target-slot ${{ env.PRODUCTION_SLOT }}

          SWAP_END=$(date +%s)
          SWAP_DURATION=$((SWAP_END - SWAP_START))

          echo "## Slot Swap Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${SWAP_DURATION} seconds" >> $GITHUB_STEP_SUMMARY
          echo "- Source: ${{ env.STAGING_SLOT }}" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${{ env.PRODUCTION_SLOT }}" >> $GITHUB_STEP_SUMMARY

      - name: Post-swap health verification
        run: |
          PROD_URL="https://mystira.app/api${{ env.HEALTH_CHECK_ENDPOINT }}"

          echo "Verifying production health post-swap..."
          echo "### Post-Swap Production Health" >> $GITHUB_STEP_SUMMARY

          sleep 15  # Brief wait for swap to fully propagate

          for i in 1 2 3 4 5; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${PROD_URL}" || echo "000")
            echo "- Check ${i}: HTTP ${HTTP_STATUS}" >> $GITHUB_STEP_SUMMARY

            if [ "$HTTP_STATUS" != "200" ]; then
              echo "::warning::Post-swap health check ${i} returned HTTP ${HTTP_STATUS}"
            fi

            sleep 5
          done

  post-deployment-monitoring:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [swap-to-production]
    steps:
      - name: Monitor error rates
        run: |
          echo "## Post-Deployment Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring Period**: 5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PROD_URL="https://mystira.app/api"
          ERROR_COUNT=0
          TOTAL_CHECKS=30

          for i in $(seq 1 $TOTAL_CHECKS); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${PROD_URL}/health" || echo "000")

            if [ "$HTTP_STATUS" != "200" ]; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi

            sleep 10
          done

          ERROR_RATE=$((ERROR_COUNT * 100 / TOTAL_CHECKS))

          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Checks | ${TOTAL_CHECKS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${ERROR_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Rate | ${ERROR_RATE}% |" >> $GITHUB_STEP_SUMMARY

          if [ $ERROR_RATE -gt 10 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ALERT**: Error rate exceeds 10% threshold!" >> $GITHUB_STEP_SUMMARY
            echo "::error::Post-deployment error rate is ${ERROR_RATE}%. Consider rollback."
          fi

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [validate-confirmation, deploy-to-staging-slot, health-check-staging, swap-to-production, post-deployment-monitoring]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "# Blue-Green Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate-confirmation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Deploy | ${{ needs.deploy-to-staging-slot.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Slot Swap | ${{ needs.swap-to-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ needs.post-deployment-monitoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID**: ${{ needs.validate-confirmation.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.swap-to-production.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Result: DEPLOYMENT SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
            echo "Production URL: https://mystira.app/api" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Result: DEPLOYMENT FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Review the logs and consider running rollback workflow." >> $GITHUB_STEP_SUMMARY
          fi
