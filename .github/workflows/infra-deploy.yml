name: Infrastructure Deploy

on:
  push:
    branches: [main]
    paths:
      - "infra/terraform/**"
      - "infra/kubernetes/**"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:
    # Manual trigger for infrastructure deployments
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      components:
        description: "Components to deploy (comma-separated: chain,publisher,all)"
        required: true
        default: "all"
        type: string

concurrency:
  group: infra-deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  TF_VERSION: 1.5.0
  AZURE_RESOURCE_GROUP: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-rg-eus
  AKS_CLUSTER_NAME: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-aks-eus

jobs:
  plan-terraform:
    name: Plan Terraform - ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      plan-exit-code: ${{ steps.plan.outputs.exitcode }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure credentials for Terraform
        run: |
          # Extract credentials from AZURE_CREDENTIALS secret
          ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId') || { echo "Failed to extract clientId"; exit 1; }
          ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret') || { echo "Failed to extract clientSecret"; exit 1; }
          ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId') || { echo "Failed to extract subscriptionId"; exit 1; }
          ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId') || { echo "Failed to extract tenantId"; exit 1; }

          # Mask the client secret to prevent exposure in logs
          echo "::add-mask::$ARM_CLIENT_SECRET"

          {
            echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
            echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET"
            echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
            echo "ARM_TENANT_ID=$ARM_TENANT_ID"
            echo "ARM_USE_CLI=false"
          } >> "$GITHUB_ENV"

      - name: Bootstrap Terraform Backend
        run: |
          chmod +x infra/scripts/bootstrap-terraform-backend.sh
          infra/scripts/bootstrap-terraform-backend.sh

      - name: Terraform Init
        run: |
          cd infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
          terraform plan -out=tfplan -detailed-exitcode || echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'dev' }}
          path: infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}/tfplan
          retention-days: 5

  apply-terraform:
    name: Apply Terraform - ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [plan-terraform]
    if: needs.plan-terraform.outputs.plan-exit-code == '2'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure credentials for Terraform
        run: |
          # Extract credentials from AZURE_CREDENTIALS secret
          ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId') || { echo "Failed to extract clientId"; exit 1; }
          ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret') || { echo "Failed to extract clientSecret"; exit 1; }
          ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId') || { echo "Failed to extract subscriptionId"; exit 1; }
          ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId') || { echo "Failed to extract tenantId"; exit 1; }

          # Mask the client secret to prevent exposure in logs
          echo "::add-mask::$ARM_CLIENT_SECRET"

          {
            echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
            echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET"
            echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
            echo "ARM_TENANT_ID=$ARM_TENANT_ID"
            echo "ARM_USE_CLI=false"
          } >> "$GITHUB_ENV"

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'dev' }}
          path: infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}

      - name: Bootstrap Terraform Backend
        run: |
          chmod +x infra/scripts/bootstrap-terraform-backend.sh
          infra/scripts/bootstrap-terraform-backend.sh

      - name: Terraform Init
        run: |
          cd infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
          terraform init

      - name: Terraform Apply
        run: |
          cd infra/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
          terraform apply -auto-approve tfplan

  deploy-chain:
    name: Deploy Chain - ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [apply-terraform]
    if: always() && (needs.apply-terraform.result == 'success' || needs.apply-terraform.result == 'skipped') && (github.event.inputs.components == 'all' || contains(github.event.inputs.components, 'chain'))
    environment: ${{ github.event.inputs.environment || 'dev' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace if not exists
        run: |
          kubectl create namespace mys-${{ github.event.inputs.environment || 'dev' }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Chain to AKS
        run: |
          kubectl apply -k infra/kubernetes/overlays/${{ github.event.inputs.environment || 'dev' }}
          kubectl rollout status statefulset/mys-chain -n mys-${{ github.event.inputs.environment || 'dev' }} --timeout=600s

  deploy-publisher:
    name: Deploy Publisher - ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    needs: [apply-terraform, deploy-chain]
    if: always() && (needs.apply-terraform.result == 'success' || needs.apply-terraform.result == 'skipped') && (needs.deploy-chain.result == 'success' || needs.deploy-chain.result == 'skipped') && (github.event.inputs.components == 'all' || contains(github.event.inputs.components, 'publisher'))
    environment: ${{ github.event.inputs.environment || 'dev' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace if not exists
        run: |
          kubectl create namespace mys-${{ github.event.inputs.environment || 'dev' }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Publisher to AKS
        run: |
          kubectl apply -k infra/kubernetes/overlays/${{ github.event.inputs.environment || 'dev' }}
          kubectl rollout status deployment/mys-publisher -n mys-${{ github.event.inputs.environment || 'dev' }} --timeout=300s

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-chain, deploy-publisher]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Azure Resource Group: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-rg-eus" >> $GITHUB_STEP_SUMMARY
          echo "- AKS Cluster: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-aks-eus" >> $GITHUB_STEP_SUMMARY
          echo "- Chain Deploy: ${{ needs.deploy-chain.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Publisher Deploy: ${{ needs.deploy-publisher.result }}" >> $GITHUB_STEP_SUMMARY
