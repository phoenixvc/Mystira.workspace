name: Infrastructure Deploy

on:
  push:
    branches: [main]
    paths:
      - "infra/terraform/**"
      - "infra/kubernetes/**"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      components:
        description: "Components to deploy"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - terraform-only
          - kubernetes-only
          - chain
          - publisher
      skip_validation:
        description: "Skip pre-deployment validation"
        required: false
        default: false
        type: boolean

concurrency:
  group: infra-deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  TF_VERSION: "1.5.0"
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  AZURE_RESOURCE_GROUP: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-rg-san
  AKS_CLUSTER_NAME: mys-${{ github.event.inputs.environment || 'dev' }}-mystira-aks-san
  ACR_NAME: mysprodacr
  DNS_ZONE: mystira.app
  TERRAFORM_RG: mys-prod-terraform-rg-eus
  TERRAFORM_STORAGE: mysprodterraformstate

jobs:
  # ============================================
  # Pre-deployment Validation
  # ============================================
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_validation != 'true' }}
    outputs:
      backend-exists: ${{ steps.check-backend.outputs.exists }}
      acr-exists: ${{ steps.check-acr.outputs.exists }}
      dns-zone-exists: ${{ steps.check-dns.outputs.exists }}
      aks-exists: ${{ steps.check-aks.outputs.exists }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Check Terraform Backend
        id: check-backend
        run: |
          if az storage account show --name ${{ env.TERRAFORM_STORAGE }} --resource-group ${{ env.TERRAFORM_RG }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::Terraform backend storage exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Terraform backend storage does not exist - will be created"
          fi

      - name: Check Container Registry
        id: check-acr
        run: |
          if az acr show --name ${{ env.ACR_NAME }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::Container Registry exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Container Registry does not exist - will be created"
          fi

      - name: Check DNS Zone
        id: check-dns
        run: |
          if az network dns zone show --name ${{ env.DNS_ZONE }} --resource-group ${{ env.TERRAFORM_RG }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::DNS Zone exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::DNS Zone does not exist - will be created"
          fi

      - name: Check AKS Cluster
        id: check-aks
        run: |
          if az aks show --name ${{ env.AKS_CLUSTER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster does not exist - Kubernetes deployment will be skipped"
          fi

      - name: Validation Summary
        run: |
          echo "## Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Backend | ${{ steps.check-backend.outputs.exists == 'true' && 'âœ… Exists' || 'âš ï¸ Will Create' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Registry | ${{ steps.check-acr.outputs.exists == 'true' && 'âœ… Exists' || 'âš ï¸ Will Create' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DNS Zone | ${{ steps.check-dns.outputs.exists == 'true' && 'âœ… Exists' || 'âš ï¸ Will Create' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AKS Cluster | ${{ steps.check-aks.outputs.exists == 'true' && 'âœ… Exists' || 'â­ï¸ Not Found (K8s deploy skipped)' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Bootstrap Infrastructure Prerequisites
  # ============================================
  bootstrap:
    name: Bootstrap Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    if: |
      always() &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped') &&
      (needs.validate.outputs.backend-exists != 'true' ||
       needs.validate.outputs.acr-exists != 'true' ||
       needs.validate.outputs.dns-zone-exists != 'true')
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Create Terraform Resource Group
        if: needs.validate.outputs.backend-exists != 'true'
        run: |
          az group create \
            --name ${{ env.TERRAFORM_RG }} \
            --location eastus \
            --output none
          echo "::notice::Created Terraform resource group"

      - name: Create Terraform Backend Storage
        if: needs.validate.outputs.backend-exists != 'true'
        run: |
          az storage account create \
            --name ${{ env.TERRAFORM_STORAGE }} \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --location eastus \
            --sku Standard_LRS \
            --kind StorageV2 \
            --output none

          STORAGE_KEY=$(az storage account keys list \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --account-name ${{ env.TERRAFORM_STORAGE }} \
            --query "[0].value" -o tsv)

          az storage container create \
            --name tfstate \
            --account-name ${{ env.TERRAFORM_STORAGE }} \
            --account-key "$STORAGE_KEY" \
            --output none

          echo "::notice::Created Terraform backend storage"

      - name: Create Container Registry
        if: needs.validate.outputs.acr-exists != 'true'
        run: |
          az acr create \
            --name ${{ env.ACR_NAME }} \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --location eastus \
            --sku Basic \
            --admin-enabled true \
            --output none
          echo "::notice::Created Container Registry"

      - name: Create DNS Zone
        if: needs.validate.outputs.dns-zone-exists != 'true'
        run: |
          az network dns zone create \
            --name ${{ env.DNS_ZONE }} \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --output none

          echo "::warning::DNS Zone created. Update your domain registrar nameservers!"
          echo "## DNS Nameservers" >> $GITHUB_STEP_SUMMARY
          echo "Update your domain registrar with these nameservers:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          az network dns zone show --name ${{ env.DNS_ZONE }} --resource-group ${{ env.TERRAFORM_RG }} --query nameServers -o tsv >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Terraform Plan
  # ============================================
  plan-terraform:
    name: Plan Terraform
    runs-on: ubuntu-latest
    needs: [validate, bootstrap]
    if: |
      always() &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped') &&
      (needs.bootstrap.result == 'success' || needs.bootstrap.result == 'skipped') &&
      (github.event.inputs.components == 'all' || github.event.inputs.components == 'terraform-only' || github.event.inputs.components == '')
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      plan-exit-code: ${{ steps.plan.outputs.exitcode }}
      aks-exists: ${{ steps.check-aks-plan.outputs.exists }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Set Azure credentials for Terraform
        run: |
          ARM_CLIENT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientId')
          ARM_CLIENT_SECRET=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
          ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
          ARM_TENANT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.tenantId')
          echo "::add-mask::$ARM_CLIENT_SECRET"
          {
            echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
            echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET"
            echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
            echo "ARM_TENANT_ID=$ARM_TENANT_ID"
            echo "ARM_USE_CLI=false"
          } >> "$GITHUB_ENV"

      - name: Terraform Init
        run: |
          cd infra/terraform/environments/${{ env.ENVIRONMENT }}
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          cd infra/terraform/environments/${{ env.ENVIRONMENT }}
          set +e
          terraform plan -out=tfplan -detailed-exitcode
          exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          if [ $exitcode -eq 1 ]; then
            exit 1
          fi

      - name: Upload Plan
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v6
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}
          path: infra/terraform/environments/${{ env.ENVIRONMENT }}/tfplan
          retention-days: 5

      - name: Check AKS Cluster (for downstream jobs)
        id: check-aks-plan
        run: |
          if az aks show --name ${{ env.AKS_CLUSTER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster does not exist"
          fi

      - name: Plan Summary
        run: |
          echo "## Terraform Plan - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "âœ… No changes needed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "ðŸ“ Changes detected - will apply" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Plan failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AKS Cluster: ${{ steps.check-aks-plan.outputs.exists == 'true' && 'âœ… Exists' || 'âŒ Not Found' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Terraform Apply
  # ============================================
  apply-terraform:
    name: Apply Terraform
    runs-on: ubuntu-latest
    needs: [plan-terraform]
    if: needs.plan-terraform.outputs.plan-exit-code == '2'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      aks-exists: ${{ steps.check-aks-post-apply.outputs.exists }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Set Azure credentials for Terraform
        run: |
          ARM_CLIENT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientId')
          ARM_CLIENT_SECRET=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
          ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
          ARM_TENANT_ID=$(echo '${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}' | jq -r '.tenantId')
          echo "::add-mask::$ARM_CLIENT_SECRET"
          {
            echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
            echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET"
            echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
            echo "ARM_TENANT_ID=$ARM_TENANT_ID"
            echo "ARM_USE_CLI=false"
          } >> "$GITHUB_ENV"

      - name: Download Plan
        uses: actions/download-artifact@v7
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}
          path: infra/terraform/environments/${{ env.ENVIRONMENT }}

      - name: Terraform Init
        run: |
          cd infra/terraform/environments/${{ env.ENVIRONMENT }}
          terraform init

      - name: Terraform Apply
        id: apply
        run: |
          cd infra/terraform/environments/${{ env.ENVIRONMENT }}
          terraform apply -auto-approve tfplan

      - name: Check AKS Cluster After Apply
        id: check-aks-post-apply
        run: |
          if az aks show --name ${{ env.AKS_CLUSTER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster exists after Terraform apply"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::AKS Cluster not found after Terraform apply"
          fi

      - name: Apply Summary
        run: |
          echo "## Terraform Apply - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure applied successfully" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Configure DNS Records (AKS-based)
  # ============================================
  configure-dns:
    name: Configure DNS
    runs-on: ubuntu-latest
    needs: [validate, plan-terraform, apply-terraform]
    if: |
      always() &&
      (needs.apply-terraform.result == 'success' || needs.apply-terraform.result == 'skipped') &&
      (needs.plan-terraform.outputs.aks-exists == 'true' || needs.apply-terraform.outputs.aks-exists == 'true')
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Wait for Ingress Controller
        run: |
          echo "Waiting for NGINX Ingress Controller..."
          for i in {1..30}; do
            IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$IP" ]; then
              echo "Ingress IP: $IP"
              echo "INGRESS_IP=$IP" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for Load Balancer IP... ($i/30)"
            sleep 10
          done

      - name: Configure DNS A Records
        if: env.INGRESS_IP != ''
        run: |
          ENV_PREFIX="${{ env.ENVIRONMENT }}"
          if [ "$ENV_PREFIX" == "prod" ]; then
            ENV_PREFIX=""
          else
            ENV_PREFIX="${ENV_PREFIX}."
          fi

          # Configure Publisher DNS
          az network dns record-set a add-record \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --zone-name ${{ env.DNS_ZONE }} \
            --record-set-name "${ENV_PREFIX}publisher" \
            --ipv4-address ${{ env.INGRESS_IP }} \
            --if-none-match || true

          # Configure Chain DNS
          az network dns record-set a add-record \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --zone-name ${{ env.DNS_ZONE }} \
            --record-set-name "${ENV_PREFIX}chain" \
            --ipv4-address ${{ env.INGRESS_IP }} \
            --if-none-match || true

          # Configure API DNS
          az network dns record-set a add-record \
            --resource-group ${{ env.TERRAFORM_RG }} \
            --zone-name ${{ env.DNS_ZONE }} \
            --record-set-name "${ENV_PREFIX}api" \
            --ipv4-address ${{ env.INGRESS_IP }} \
            --if-none-match || true

          echo "::notice::DNS records configured for ${{ env.ENVIRONMENT }}"

      - name: DNS Summary
        run: |
          echo "## DNS Configuration - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.INGRESS_IP }}" ]; then
            echo "âœ… Load Balancer IP: ${{ env.INGRESS_IP }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
            if [ "${{ env.ENVIRONMENT }}" == "prod" ]; then
              echo "| Publisher | https://publisher.mystira.app |" >> $GITHUB_STEP_SUMMARY
              echo "| Chain | https://chain.mystira.app |" >> $GITHUB_STEP_SUMMARY
              echo "| API | https://api.mystira.app |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Publisher | https://${{ env.ENVIRONMENT }}.publisher.mystira.app |" >> $GITHUB_STEP_SUMMARY
              echo "| Chain | https://${{ env.ENVIRONMENT }}.chain.mystira.app |" >> $GITHUB_STEP_SUMMARY
              echo "| API | https://${{ env.ENVIRONMENT }}.api.mystira.app |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No Load Balancer IP available yet" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [apply-terraform]
    if: |
      always() &&
      (needs.apply-terraform.result == 'success' || needs.apply-terraform.result == 'skipped') &&
      (github.event.inputs.components == 'all' || github.event.inputs.components == '')
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          token: ${{ secrets.GH_PAT }}
          persist-credentials: true

      - name: Verify submodules
        run: |
          echo "Checking submodule status..."
          git submodule status
          echo ""
          echo "Packages directory contents:"
          ls -la packages/
          echo ""
          echo "Chain package contents:"
          ls -la packages/chain/ || echo "Chain directory empty or missing"
          echo ""
          echo "Publisher package contents:"
          ls -la packages/publisher/ || echo "Publisher directory empty or missing"
          echo ""
          # Fail if submodules are empty (chain is Python, publisher is Node.js)
          if [ ! -f "packages/chain/server.py" ]; then
            echo "::error::packages/chain/server.py not found - submodule checkout failed"
            echo "Make sure GH_PAT has access to https://github.com/phoenixvc/Mystira.Chain"
            exit 1
          fi
          if [ ! -f "packages/publisher/package.json" ]; then
            echo "::error::packages/publisher/package.json not found - submodule checkout failed"
            echo "Make sure GH_PAT has access to https://github.com/phoenixvc/Mystira.Publisher"
            exit 1
          fi
          echo "âœ… Submodules verified successfully"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push Publisher
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/publisher:${{ env.ENVIRONMENT }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/publisher:${{ github.sha }} \
            -f infra/docker/publisher/Dockerfile \
            .
          docker push ${{ env.ACR_NAME }}.azurecr.io/publisher:${{ env.ENVIRONMENT }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/publisher:${{ github.sha }}

      - name: Build and Push Chain
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/chain:${{ env.ENVIRONMENT }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/chain:${{ github.sha }} \
            -f infra/docker/chain/Dockerfile \
            .
          docker push ${{ env.ACR_NAME }}.azurecr.io/chain:${{ env.ENVIRONMENT }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/chain:${{ github.sha }}

      - name: Image Summary
        run: |
          echo "## Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tags |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| publisher | ${{ env.ENVIRONMENT }}, ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| chain | ${{ env.ENVIRONMENT }}, ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Kubernetes
  # ============================================
  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [validate, plan-terraform, apply-terraform, configure-dns, build-images]
    if: |
      always() &&
      (needs.plan-terraform.outputs.aks-exists == 'true' || needs.apply-terraform.outputs.aks-exists == 'true') &&
      (needs.apply-terraform.result == 'success' || needs.apply-terraform.result == 'skipped') &&
      (needs.build-images.result == 'success' || needs.build-images.result == 'skipped') &&
      (github.event.inputs.components == 'all' ||
       github.event.inputs.components == 'kubernetes-only' ||
       github.event.inputs.components == 'chain' ||
       github.event.inputs.components == 'publisher' ||
       github.event.inputs.components == '')
    environment: ${{ github.event.inputs.environment || 'dev' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.MYSTIRA_AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace
        run: |
          kubectl create namespace mys-${{ env.ENVIRONMENT }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ACR Pull Secret
        run: |
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          kubectl create secret docker-registry acr-secret \
            --namespace mys-${{ env.ENVIRONMENT }} \
            --docker-server=${{ env.ACR_NAME }}.azurecr.io \
            --docker-username=$ACR_USERNAME \
            --docker-password=$ACR_PASSWORD \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy cert-manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml || true
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=300s || true

      - name: Deploy Applications
        run: |
          kubectl apply -k infra/kubernetes/overlays/${{ env.ENVIRONMENT }}

      - name: Wait for Deployments
        run: |
          echo "Waiting for deployments to be ready..."
          kubectl rollout status deployment/mys-publisher -n mys-${{ env.ENVIRONMENT }} --timeout=300s || true
          kubectl rollout status statefulset/mys-chain -n mys-${{ env.ENVIRONMENT }} --timeout=600s || true

      - name: Deployment Summary
        run: |
          echo "## Kubernetes Deployment - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pods" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n mys-${{ env.ENVIRONMENT }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n mys-${{ env.ENVIRONMENT }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ingress" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n mys-${{ env.ENVIRONMENT }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Final Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, bootstrap, plan-terraform, apply-terraform, configure-dns, build-images, deploy-kubernetes]
    if: always()
    steps:
      - name: Final Summary
        run: |
          echo "# Deployment Summary - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result == 'success' && 'âœ…' || needs.validate.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bootstrap | ${{ needs.bootstrap.result == 'success' && 'âœ…' || needs.bootstrap.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Plan | ${{ needs.plan-terraform.result == 'success' && 'âœ…' || needs.plan-terraform.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Apply | ${{ needs.apply-terraform.result == 'success' && 'âœ…' || needs.apply-terraform.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DNS Config | ${{ needs.configure-dns.result == 'success' && 'âœ…' || needs.configure-dns.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build-images.result == 'success' && 'âœ…' || needs.build-images.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy K8s | ${{ needs.deploy-kubernetes.result == 'success' && 'âœ…' || needs.deploy-kubernetes.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment URLs" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.ENVIRONMENT }}" == "prod" ]; then
            echo "- Publisher: https://publisher.mystira.app" >> $GITHUB_STEP_SUMMARY
            echo "- Chain: https://chain.mystira.app" >> $GITHUB_STEP_SUMMARY
            echo "- API: https://api.mystira.app" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Publisher: https://${{ env.ENVIRONMENT }}.publisher.mystira.app" >> $GITHUB_STEP_SUMMARY
            echo "- Chain: https://${{ env.ENVIRONMENT }}.chain.mystira.app" >> $GITHUB_STEP_SUMMARY
            echo "- API: https://${{ env.ENVIRONMENT }}.api.mystira.app" >> $GITHUB_STEP_SUMMARY
          fi
